<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>MedaGama Backend Reference</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;max-width:900px;margin:40px auto;padding:0 20px;color:#1a1a1a;line-height:1.6}
h1{font-size:24px}h2{font-size:20px}h3{font-size:16px}
pre{white-space:pre-wrap;word-wrap:break-word}
code{font-family:'SF Mono',Menlo,monospace;font-size:13px}
table{border-collapse:collapse;width:100%}
td,th{border:1px solid #ddd;padding:8px;text-align:left}
@media print{body{max-width:100%}pre{font-size:11px;page-break-inside:avoid}}
</style></head><body>
<p><h1 style="color:#0d9488;margin-top:40px">MedaGama Backend — Controller &amp; Model Kod Referansı</h1></p><p><strong>Tarih:</strong> 19 Şubat 2026  <br><strong>Framework:</strong> Laravel 11 (PHP 8.3)  <br><strong>Veritabanı:</strong> PostgreSQL (UUID primary keys)  <br><strong>Auth:</strong> Laravel Sanctum (Bearer Token)</p><p><hr style="margin:30px 0"></p><p><h1 style="color:#0d9488;margin-top:40px">BÖLÜM 1: MODELS</h1></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.1 User Model</h2></p><p><strong>Dosya:</strong> `app/Models/User.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\SoftDeletes;<br>use Illuminate\Foundation\Auth\User as Authenticatable;<br>use Illuminate\Notifications\Notifiable;<br>use Laravel\Sanctum\HasApiTokens;</p><p>class User extends Authenticatable<br>{<br>    use HasApiTokens, HasFactory, HasUuids, Notifiable;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'email', 'password', 'fullname', 'avatar', 'role_id', 'mobile',<br>        'mobile_verified', 'email_verified', 'email_verification_code',<br>        'password_reset_code', 'password_reset_expires_at',<br>        'city_id', 'country_id', 'country', 'preferred_language',<br>        'date_of_birth', 'gender', 'is_verified', 'last_login', 'clinic_id',<br>        'medical_history', 'notification_preferences',<br>    ];</p><p>    protected $hidden = [<br>        'password', 'remember_token',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'password' =&gt; 'hashed',<br>            'mobile_verified' =&gt; 'boolean',<br>            'email_verified' =&gt; 'boolean',<br>            'is_verified' =&gt; 'boolean',<br>            'is_active' =&gt; 'boolean',<br>            'date_of_birth' =&gt; 'date',<br>            'last_login' =&gt; 'datetime',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function scopeRole($query, string $role)<br>    {<br>        return $query-&gt;where('role_id', $role);<br>    }</p><p>    public function scopePatients($query)<br>    {<br>        return $query-&gt;where('role_id', 'patient');<br>    }</p><p>    public function scopeDoctors($query)<br>    {<br>        return $query-&gt;where('role_id', 'doctor');<br>    }</p><p>    public function clinic()<br>    {<br>        return $this-&gt;belongsTo(Clinic::class);<br>    }</p><p>    public function ownedClinic()<br>    {<br>        return $this-&gt;hasOne(Clinic::class, 'owner_id');<br>    }</p><p>    public function doctorAppointments()<br>    {<br>        return $this-&gt;hasMany(Appointment::class, 'doctor_id');<br>    }</p><p>    public function patientAppointments()<br>    {<br>        return $this-&gt;hasMany(Appointment::class, 'patient_id');<br>    }</p><p>    public function calendarSlots()<br>    {<br>        return $this-&gt;hasMany(CalendarSlot::class, 'doctor_id');<br>    }</p><p>    public function digitalAnamnesis()<br>    {<br>        return $this-&gt;hasOne(DigitalAnamnesis::class, 'patient_id');<br>    }</p><p>    public function patientRecords()<br>    {<br>        return $this-&gt;hasMany(PatientRecord::class, 'patient_id');<br>    }</p><p>    public function crmTags()<br>    {<br>        return $this-&gt;hasMany(CrmTag::class, 'patient_id');<br>    }</p><p>    public function doctorProfile()<br>    {<br>        return $this-&gt;hasOne(DoctorProfile::class);<br>    }</p><p>    public function medStreamPosts()<br>    {<br>        return $this-&gt;hasMany(MedStreamPost::class, 'author_id');<br>    }</p><p>    public function bookmarks()<br>    {<br>        return $this-&gt;hasMany(MedStreamBookmark::class, 'user_id');<br>    }</p><p>    public function conversations()<br>    {<br>        return $this-&gt;belongsToMany(Conversation::class, 'conversation_participants')<br>            -&gt;withPivot(['role', 'last_read_at', 'is_muted', 'is_archived', 'is_active'])<br>            -&gt;withTimestamps();<br>    }</p><p>    public function sentMessages()<br>    {<br>        return $this-&gt;hasMany(Message::class, 'sender_id');<br>    }</p><p>    public function isAdmin(): bool<br>    {<br>        return in_array($this-&gt;role_id, ['superAdmin', 'saasAdmin']);<br>    }</p><p>    public function isDoctor(): bool<br>    {<br>        return $this-&gt;role_id === 'doctor';<br>    }</p><p>    public function isPatient(): bool<br>    {<br>        return $this-&gt;role_id === 'patient';<br>    }</p><p>    public function isClinicOwner(): bool<br>    {<br>        return $this-&gt;role_id === 'clinicOwner';<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.2 DoctorProfile Model</h2></p><p><strong>Dosya:</strong> `app/Models/DoctorProfile.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class DoctorProfile extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'user_id',<br>        'title',<br>        'specialty',<br>        'sub_specialties',<br>        'bio',<br>        'experience_years',<br>        'license_number',<br>        'education',<br>        'certifications',<br>        'services',<br>        'prices',<br>        'languages',<br>        'address',<br>        'map_coordinates',<br>        'phone',<br>        'website',<br>        'gallery',<br>        'online_consultation',<br>        'accepts_insurance',<br>        'insurance_providers',<br>        'onboarding_completed',<br>        'onboarding_step',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'sub_specialties'    =&gt; 'array',<br>            'education'          =&gt; 'array',<br>            'certifications'     =&gt; 'array',<br>            'services'           =&gt; 'array',<br>            'prices'             =&gt; 'array',<br>            'languages'          =&gt; 'array',<br>            'map_coordinates'    =&gt; 'array',<br>            'gallery'            =&gt; 'array',<br>            'insurance_providers'=&gt; 'array',<br>            'online_consultation'=&gt; 'boolean',<br>            'accepts_insurance'  =&gt; 'boolean',<br>            'onboarding_completed' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function user()<br>    {<br>        return $this-&gt;belongsTo(User::class);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.3 Clinic Model</h2></p><p><strong>Dosya:</strong> `app/Models/Clinic.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class Clinic extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'name', 'codename', 'fullname', 'avatar', 'owner_id',<br>        'address', 'biography', 'map_coordinates', 'website', 'is_verified',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'map_coordinates' =&gt; 'array',<br>            'is_verified' =&gt; 'boolean',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function owner()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'owner_id');<br>    }</p><p>    public function staff()<br>    {<br>        return $this-&gt;hasMany(User::class, 'clinic_id');<br>    }</p><p>    public function doctors()<br>    {<br>        return $this-&gt;hasMany(User::class, 'clinic_id')-&gt;where('role_id', 'doctor');<br>    }</p><p>    public function appointments()<br>    {<br>        return $this-&gt;hasMany(Appointment::class);<br>    }</p><p>    public function calendarSlots()<br>    {<br>        return $this-&gt;hasMany(CalendarSlot::class);<br>    }</p><p>    public function archivedRecords()<br>    {<br>        return $this-&gt;hasMany(ArchivedClinicRecord::class);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.4 Appointment Model</h2></p><p><strong>Dosya:</strong> `app/Models/Appointment.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class Appointment extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'patient_id', 'doctor_id', 'clinic_id', 'appointment_type', 'slot_id',<br>        'appointment_date', 'appointment_time', 'status', 'confirmation_note',<br>        'video_conference_link', 'doctor_note', 'created_by',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'appointment_date' =&gt; 'date',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function patient()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'patient_id');<br>    }</p><p>    public function doctor()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'doctor_id');<br>    }</p><p>    public function clinic()<br>    {<br>        return $this-&gt;belongsTo(Clinic::class);<br>    }</p><p>    public function slot()<br>    {<br>        return $this-&gt;belongsTo(CalendarSlot::class, 'slot_id');<br>    }</p><p>    public function creator()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'created_by');<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.5 CalendarSlot Model</h2></p><p><strong>Dosya:</strong> `app/Models/CalendarSlot.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class CalendarSlot extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'doctor_id', 'clinic_id', 'slot_date', 'start_time',<br>        'duration_minutes', 'is_available',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'slot_date' =&gt; 'date',<br>            'is_available' =&gt; 'boolean',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function scopeAvailable($query)<br>    {<br>        return $query-&gt;where('is_available', true);<br>    }</p><p>    public function doctor()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'doctor_id');<br>    }</p><p>    public function clinic()<br>    {<br>        return $this-&gt;belongsTo(Clinic::class);<br>    }</p><p>    public function appointment()<br>    {<br>        return $this-&gt;hasOne(Appointment::class, 'slot_id');<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.6 MedStreamPost Model</h2></p><p><strong>Dosya:</strong> `app/Models/MedStreamPost.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class MedStreamPost extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'author_id', 'clinic_id', 'post_type', 'content', 'media_url', 'media', 'is_hidden',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'is_hidden' =&gt; 'boolean',<br>            'is_active' =&gt; 'boolean',<br>            'media'     =&gt; 'array',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function scopeVisible($query)<br>    {<br>        return $query-&gt;where('is_hidden', false)-&gt;where('is_active', true);<br>    }</p><p>    public function author()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'author_id');<br>    }</p><p>    public function clinic()<br>    {<br>        return $this-&gt;belongsTo(Clinic::class);<br>    }</p><p>    public function comments()<br>    {<br>        return $this-&gt;hasMany(MedStreamComment::class, 'post_id');<br>    }</p><p>    public function likes()<br>    {<br>        return $this-&gt;hasMany(MedStreamLike::class, 'post_id');<br>    }</p><p>    public function reports()<br>    {<br>        return $this-&gt;hasMany(MedStreamReport::class, 'post_id');<br>    }</p><p>    public function engagementCounter()<br>    {<br>        return $this-&gt;hasOne(MedStreamEngagementCounter::class, 'post_id');<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.7 MedStreamComment Model</h2></p><p><strong>Dosya:</strong> `app/Models/MedStreamComment.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class MedStreamComment extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'post_id', 'author_id', 'parent_id', 'content', 'is_hidden',<br>    ];</p><p>    public function parent()<br>    {<br>        return $this-&gt;belongsTo(MedStreamComment::class, 'parent_id');<br>    }</p><p>    public function replies()<br>    {<br>        return $this-&gt;hasMany(MedStreamComment::class, 'parent_id')-&gt;active()-&gt;where('is_hidden', false);<br>    }</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'is_hidden' =&gt; 'boolean',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function post()<br>    {<br>        return $this-&gt;belongsTo(MedStreamPost::class, 'post_id');<br>    }</p><p>    public function author()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'author_id');<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.8 MedStreamLike Model</h2></p><p><strong>Dosya:</strong> `app/Models/MedStreamLike.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class MedStreamLike extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = ['post_id', 'user_id'];</p><p>    protected function casts(): array<br>    {<br>        return ['is_active' =&gt; 'boolean'];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function post()<br>    {<br>        return $this-&gt;belongsTo(MedStreamPost::class, 'post_id');<br>    }</p><p>    public function user()<br>    {<br>        return $this-&gt;belongsTo(User::class);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.9 MedStreamBookmark Model</h2></p><p><strong>Dosya:</strong> `app/Models/MedStreamBookmark.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class MedStreamBookmark extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = ['user_id', 'bookmarked_type', 'target_id'];</p><p>    protected function casts(): array<br>    {<br>        return ['is_active' =&gt; 'boolean'];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function user()<br>    {<br>        return $this-&gt;belongsTo(User::class);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.10 MedStreamReport Model</h2></p><p><strong>Dosya:</strong> `app/Models/MedStreamReport.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class MedStreamReport extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = ['post_id', 'reporter_id', 'reason', 'admin_status'];</p><p>    protected function casts(): array<br>    {<br>        return ['is_active' =&gt; 'boolean'];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function post()<br>    {<br>        return $this-&gt;belongsTo(MedStreamPost::class, 'post_id');<br>    }</p><p>    public function reporter()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'reporter_id');<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.11 MedStreamEngagementCounter Model</h2></p><p><strong>Dosya:</strong> `app/Models/MedStreamEngagementCounter.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class MedStreamEngagementCounter extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = ['post_id', 'like_count', 'comment_count'];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'like_count' =&gt; 'integer',<br>            'comment_count' =&gt; 'integer',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function post()<br>    {<br>        return $this-&gt;belongsTo(MedStreamPost::class, 'post_id');<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.12 Conversation Model</h2></p><p><strong>Dosya:</strong> `app/Models/Conversation.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class Conversation extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'title',<br>        'type',<br>        'clinic_id',<br>        'is_active',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function scopeForUser($query, string $userId)<br>    {<br>        return $query-&gt;whereHas('participants', function ($q) use ($userId) {<br>            $q-&gt;where('user_id', $userId)-&gt;where('is_active', true);<br>        });<br>    }</p><p>    public function participants()<br>    {<br>        return $this-&gt;hasMany(ConversationParticipant::class);<br>    }</p><p>    public function activeParticipants()<br>    {<br>        return $this-&gt;hasMany(ConversationParticipant::class)-&gt;where('is_active', true);<br>    }</p><p>    public function users()<br>    {<br>        return $this-&gt;belongsToMany(User::class, 'conversation_participants')<br>            -&gt;withPivot(['role', 'last_read_at', 'is_muted', 'is_archived', 'is_active'])<br>            -&gt;withTimestamps();<br>    }</p><p>    public function messages()<br>    {<br>        return $this-&gt;hasMany(Message::class)-&gt;orderBy('created_at');<br>    }</p><p>    public function latestMessage()<br>    {<br>        return $this-&gt;hasOne(Message::class)<br>            -&gt;where('is_active', true)<br>            -&gt;orderByDesc('created_at')<br>            -&gt;limit(1);<br>    }</p><p>    public function clinic()<br>    {<br>        return $this-&gt;belongsTo(Clinic::class);<br>    }</p><p>    public function otherParticipant(string $userId)<br>    {<br>        return $this-&gt;activeParticipants()-&gt;where('user_id', '!=', $userId)-&gt;first();<br>    }</p><p>    public function unreadCountFor(string $userId): int<br>    {<br>        $participant = $this-&gt;participants()-&gt;where('user_id', $userId)-&gt;first();<br>        if (!$participant) return 0;</p><p>        $query = $this-&gt;messages()-&gt;where('sender_id', '!=', $userId)-&gt;where('is_active', true);<br>        if ($participant-&gt;last_read_at) {<br>            $query-&gt;where('created_at', '&gt;', $participant-&gt;last_read_at);<br>        }<br>        return $query-&gt;count();<br>    }</p><p>    public static function findOrCreateDirect(string $userA, string $userB, ?string $clinicId = null): self<br>    {<br>        $existing = static::where('type', 'direct')<br>            -&gt;where('is_active', true)<br>            -&gt;whereHas('participants', fn($q) =&gt; $q-&gt;where('user_id', $userA)-&gt;where('is_active', true))<br>            -&gt;whereHas('participants', fn($q) =&gt; $q-&gt;where('user_id', $userB)-&gt;where('is_active', true))<br>            -&gt;first();</p><p>        if ($existing) return $existing;</p><p>        $conversation = static::create([<br>            'type' =&gt; 'direct',<br>            'clinic_id' =&gt; $clinicId,<br>        ]);</p><p>        $conversation-&gt;participants()-&gt;createMany([<br>            ['user_id' =&gt; $userA, 'role' =&gt; 'member'],<br>            ['user_id' =&gt; $userB, 'role' =&gt; 'member'],<br>        ]);</p><p>        return $conversation;<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.13 ConversationParticipant Model</h2></p><p><strong>Dosya:</strong> `app/Models/ConversationParticipant.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class ConversationParticipant extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'conversation_id',<br>        'user_id',<br>        'role',<br>        'last_read_at',<br>        'is_muted',<br>        'is_archived',<br>        'is_active',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'last_read_at' =&gt; 'datetime',<br>            'is_muted' =&gt; 'boolean',<br>            'is_archived' =&gt; 'boolean',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function conversation()<br>    {<br>        return $this-&gt;belongsTo(Conversation::class);<br>    }</p><p>    public function user()<br>    {<br>        return $this-&gt;belongsTo(User::class);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.14 Message Model</h2></p><p><strong>Dosya:</strong> `app/Models/Message.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;<br>use Illuminate\Database\Eloquent\SoftDeletes;</p><p>class Message extends Model<br>{<br>    use HasFactory, HasUuids, SoftDeletes;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'conversation_id',<br>        'sender_id',<br>        'reply_to_id',<br>        'body',<br>        'type',<br>        'metadata',<br>        'is_edited',<br>        'edited_at',<br>        'is_active',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'metadata' =&gt; 'array',<br>            'is_edited' =&gt; 'boolean',<br>            'edited_at' =&gt; 'datetime',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function conversation()<br>    {<br>        return $this-&gt;belongsTo(Conversation::class);<br>    }</p><p>    public function sender()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'sender_id');<br>    }</p><p>    public function replyTo()<br>    {<br>        return $this-&gt;belongsTo(Message::class, 'reply_to_id');<br>    }</p><p>    public function replies()<br>    {<br>        return $this-&gt;hasMany(Message::class, 'reply_to_id');<br>    }</p><p>    public function attachments()<br>    {<br>        return $this-&gt;hasMany(MessageAttachment::class);<br>    }</p><p>    public function readReceipts()<br>    {<br>        return $this-&gt;hasMany(MessageReadReceipt::class);<br>    }</p><p>    public function isReadBy(string $userId): bool<br>    {<br>        return $this-&gt;readReceipts()-&gt;where('user_id', $userId)-&gt;exists();<br>    }</p><p>    public function markReadBy(string $userId): void<br>    {<br>        $this-&gt;readReceipts()-&gt;firstOrCreate(<br>            ['user_id' =&gt; $userId],<br>            ['read_at' =&gt; now()]<br>        );<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.15 MessageAttachment Model</h2></p><p><strong>Dosya:</strong> `app/Models/MessageAttachment.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class MessageAttachment extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'message_id',<br>        'file_name',<br>        'file_path',<br>        'file_type',<br>        'file_size',<br>        'thumb_path',<br>        'is_active',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'file_size' =&gt; 'integer',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function message()<br>    {<br>        return $this-&gt;belongsTo(Message::class);<br>    }</p><p>    public function getUrlAttribute(): string<br>    {<br>        return url('storage/' . $this-&gt;file_path);<br>    }</p><p>    public function getThumbUrlAttribute(): ?string<br>    {<br>        return $this-&gt;thumb_path ? url('storage/' . $this-&gt;thumb_path) : null;<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.16 MessageReadReceipt Model</h2></p><p><strong>Dosya:</strong> `app/Models/MessageReadReceipt.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class MessageReadReceipt extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'message_id',<br>        'user_id',<br>        'read_at',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'read_at' =&gt; 'datetime',<br>        ];<br>    }</p><p>    public function message()<br>    {<br>        return $this-&gt;belongsTo(Message::class);<br>    }</p><p>    public function user()<br>    {<br>        return $this-&gt;belongsTo(User::class);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.17 DigitalAnamnesis Model</h2></p><p><strong>Dosya:</strong> `app/Models/DigitalAnamnesis.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class DigitalAnamnesis extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;<br>    protected $table = 'digital_anamneses';</p><p>    protected $fillable = [<br>        'patient_id', 'doctor_id', 'clinic_id', 'answers', 'last_updated_by',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'answers' =&gt; 'array',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function patient()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'patient_id');<br>    }</p><p>    public function doctor()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'doctor_id');<br>    }</p><p>    public function clinic()<br>    {<br>        return $this-&gt;belongsTo(Clinic::class);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.18 PatientRecord Model</h2></p><p><strong>Dosya:</strong> `app/Models/PatientRecord.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class PatientRecord extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'patient_id', 'clinic_id', 'doctor_id', 'file_url',<br>        'upload_date', 'record_type', 'description',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'upload_date' =&gt; 'date',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function patient()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'patient_id');<br>    }</p><p>    public function doctor()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'doctor_id');<br>    }</p><p>    public function clinic()<br>    {<br>        return $this-&gt;belongsTo(Clinic::class);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.19 CrmTag Model</h2></p><p><strong>Dosya:</strong> `app/Models/CrmTag.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class CrmTag extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'doctor_id', 'patient_id', 'clinic_id', 'tag', 'created_by',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return ['is_active' =&gt; 'boolean'];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function doctor()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'doctor_id');<br>    }</p><p>    public function patient()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'patient_id');<br>    }</p><p>    public function clinic()<br>    {<br>        return $this-&gt;belongsTo(Clinic::class);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.20 CrmProcessStage Model</h2></p><p><strong>Dosya:</strong> `app/Models/CrmProcessStage.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class CrmProcessStage extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'doctor_id', 'patient_id', 'clinic_id', 'stage', 'started_at', 'updated_by',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'started_at' =&gt; 'date',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function doctor()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'doctor_id');<br>    }</p><p>    public function patient()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'patient_id');<br>    }</p><p>    public function clinic()<br>    {<br>        return $this-&gt;belongsTo(Clinic::class);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.21 ArchivedClinicRecord Model</h2></p><p><strong>Dosya:</strong> `app/Models/ArchivedClinicRecord.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class ArchivedClinicRecord extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = [<br>        'former_doctor_id', 'clinic_id', 'archived_patient_id',<br>        'record_references', 'archived_at',<br>    ];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'record_references' =&gt; 'array',<br>            'archived_at' =&gt; 'date',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function formerDoctor()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'former_doctor_id');<br>    }</p><p>    public function clinic()<br>    {<br>        return $this-&gt;belongsTo(Clinic::class);<br>    }</p><p>    public function archivedPatient()<br>    {<br>        return $this-&gt;belongsTo(User::class, 'archived_patient_id');<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">1.22 Catalog Models</h2></p><p><h3>City</h3></p><p><strong>Dosya:</strong> `app/Models/City.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class City extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = ['code', 'country_id', 'translations'];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'translations' =&gt; 'array',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function scopeByCountry($query, int $countryId)<br>    {<br>        return $query-&gt;where('country_id', $countryId);<br>    }<br>}<br></code></pre></p><p><h3>Specialty</h3></p><p><strong>Dosya:</strong> `app/Models/Specialty.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class Specialty extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = ['code', 'display_order', 'translations'];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'translations' =&gt; 'array',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }</p><p>    public function scopeOrdered($query)<br>    {<br>        return $query-&gt;orderBy('display_order');<br>    }<br>}<br></code></pre></p><p><h3>SymptomSpecialtyMapping</h3></p><p><strong>Dosya:</strong> `app/Models/SymptomSpecialtyMapping.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class SymptomSpecialtyMapping extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = ['symptom', 'specialty_ids', 'translations'];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'specialty_ids' =&gt; 'array',<br>            'translations' =&gt; 'array',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }<br>}<br></code></pre></p><p><h3>DiseaseCondition</h3></p><p><strong>Dosya:</strong> `app/Models/DiseaseCondition.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Models;</p><p>use Illuminate\Database\Eloquent\Concerns\HasUuids;<br>use Illuminate\Database\Eloquent\Factories\HasFactory;<br>use Illuminate\Database\Eloquent\Model;</p><p>class DiseaseCondition extends Model<br>{<br>    use HasFactory, HasUuids;</p><p>    protected $keyType = 'string';<br>    public $incrementing = false;</p><p>    protected $fillable = ['code', 'recommended_specialty_ids', 'translations'];</p><p>    protected function casts(): array<br>    {<br>        return [<br>            'recommended_specialty_ids' =&gt; 'array',<br>            'translations' =&gt; 'array',<br>            'is_active' =&gt; 'boolean',<br>        ];<br>    }</p><p>    public function scopeActive($query)<br>    {<br>        return $query-&gt;where('is_active', true);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h1 style="color:#0d9488;margin-top:40px">BÖLÜM 2: CONTROLLERS</h1></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.1 AuthController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/AuthController.php`  <br><strong>Route Prefix:</strong> `/api/auth`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\User;<br>use App\Models\MedStreamPost;<br>use App\Models\MedStreamComment;<br>use App\Models\MedStreamLike;<br>use App\Models\MedStreamBookmark;<br>use Illuminate\Http\Request;<br>use Illuminate\Support\Facades\Hash;<br>use Illuminate\Support\Str;<br>use Illuminate\Support\Facades\Mail;<br>use Illuminate\Validation\ValidationException;<br>use App\Mail\VerificationCodeMail;<br>use App\Mail\PasswordResetMail;</p><p>class AuthController extends Controller<br>{<br>    /**<br>     * POST /api/auth/register<br>     */<br>    public function register(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'email' =&gt; 'required|email',<br>            'password' =&gt; 'required|string|min:6',<br>            'fullname' =&gt; 'required|string|max:255',<br>            'mobile' =&gt; 'nullable|string|max:20',<br>            'role_id' =&gt; 'sometimes|in:patient,doctor,clinicOwner',<br>            'city_id' =&gt; 'sometimes|integer',<br>            'country_id' =&gt; 'sometimes|integer',<br>            'date_of_birth' =&gt; 'sometimes|date',<br>            'gender' =&gt; 'sometimes|in:male,female,other',<br>            'clinic_id' =&gt; 'sometimes|uuid',<br>        ]);</p><p>        $clinicId = $validated['clinic_id'] ?? null;<br>        $exists = User::where('email', $validated['email'])<br>            -&gt;where('clinic_id', $clinicId)<br>            -&gt;where('is_active', true)<br>            -&gt;exists();</p><p>        if ($exists) {<br>            throw ValidationException::withMessages([<br>                'email' =&gt; ['This email is already registered.'],<br>            ]);<br>        }</p><p>        $verificationCode = str_pad(random_int(0, 999999), 6, '0', STR_PAD_LEFT);</p><p>        $user = User::create([<br>            'email' =&gt; $validated['email'],<br>            'password' =&gt; $validated['password'],<br>            'fullname' =&gt; $validated['fullname'],<br>            'mobile' =&gt; $validated['mobile'] ?? null,<br>            'role_id' =&gt; $validated['role_id'] ?? 'patient',<br>            'city_id' =&gt; $validated['city_id'] ?? null,<br>            'country_id' =&gt; $validated['country_id'] ?? null,<br>            'date_of_birth' =&gt; $validated['date_of_birth'] ?? null,<br>            'gender' =&gt; $validated['gender'] ?? null,<br>            'clinic_id' =&gt; $clinicId,<br>            'avatar' =&gt; null,<br>            'email_verified' =&gt; false,<br>            'email_verification_code' =&gt; $verificationCode,<br>        ]);</p><p>        try {<br>            Mail::to($user-&gt;email)-&gt;send(new VerificationCodeMail($verificationCode, $user-&gt;fullname));<br>        } catch (\Throwable $e) {<br>            \Log::warning('Verification email failed: ' . $e-&gt;getMessage());<br>        }</p><p>        $token = $user-&gt;createToken('auth-token')-&gt;plainTextToken;</p><p>        return response()-&gt;json([<br>            'user' =&gt; $user,<br>            'token' =&gt; $token,<br>            'requires_email_verification' =&gt; true,<br>        ], 201);<br>    }</p><p>    /**<br>     * POST /api/auth/login<br>     */<br>    public function login(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'email' =&gt; 'required|email',<br>            'password' =&gt; 'required|string',<br>            'clinic_id' =&gt; 'sometimes|uuid',<br>        ]);</p><p>        $clinicId = $validated['clinic_id'] ?? null;</p><p>        $user = User::where('email', $validated['email'])<br>            -&gt;when($clinicId, fn($q) =&gt; $q-&gt;where('clinic_id', $clinicId))<br>            -&gt;where('is_active', true)<br>            -&gt;first();</p><p>        if (!$user || !Hash::check($validated['password'], $user-&gt;password)) {<br>            throw ValidationException::withMessages([<br>                'email' =&gt; ['The provided credentials are incorrect.'],<br>            ]);<br>        }</p><p>        $user-&gt;update(['last_login' =&gt; now()]);</p><p>        $token = $user-&gt;createToken('auth-token')-&gt;plainTextToken;</p><p>        if (!$user-&gt;email_verified) {<br>            return response()-&gt;json([<br>                'user' =&gt; $user,<br>                'token' =&gt; $token,<br>                'requires_email_verification' =&gt; true,<br>                'message' =&gt; 'Please verify your email address.',<br>            ]);<br>        }</p><p>        $userData = $user-&gt;toArray();<br>        if ($user-&gt;role_id === 'doctor') {<br>            $profile = $user-&gt;doctorProfile;<br>            $userData['onboarding_completed'] = $profile ? (bool) $profile-&gt;onboarding_completed : false;<br>        }</p><p>        return response()-&gt;json([<br>            'user' =&gt; $userData,<br>            'token' =&gt; $token,<br>        ]);<br>    }</p><p>    /**<br>     * POST /api/auth/logout<br>     */<br>    public function logout(Request $request)<br>    {<br>        $request-&gt;user()-&gt;currentAccessToken()-&gt;delete();<br>        return response()-&gt;json(['message' =&gt; 'Logged out successfully.']);<br>    }</p><p>    /**<br>     * GET /api/auth/me<br>     */<br>    public function me(Request $request)<br>    {<br>        $user = $request-&gt;user()-&gt;load('clinic');</p><p>        $extra = [];<br>        if ($user-&gt;role_id === 'doctor') {<br>            $profile = $user-&gt;doctorProfile;<br>            $extra['onboarding_completed'] = $profile ? (bool) $profile-&gt;onboarding_completed : false;<br>        }</p><p>        return response()-&gt;json(['user' =&gt; array_merge($user-&gt;toArray(), $extra)]);<br>    }</p><p>    /**<br>     * PUT /api/auth/profile<br>     */<br>    public function updateProfile(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'fullname' =&gt; 'sometimes|string|max:255',<br>            'avatar' =&gt; 'sometimes|string|url',<br>            'mobile' =&gt; 'sometimes|string|max:20',<br>            'city_id' =&gt; 'sometimes|integer',<br>            'country_id' =&gt; 'sometimes|integer',<br>            'country' =&gt; 'sometimes|string|max:5',<br>            'preferred_language' =&gt; 'sometimes|string|max:10',<br>            'date_of_birth' =&gt; 'sometimes|date',<br>            'gender' =&gt; 'sometimes|in:male,female,other',<br>        ]);</p><p>        $request-&gt;user()-&gt;update($validated);<br>        return response()-&gt;json(['user' =&gt; $request-&gt;user()-&gt;fresh()]);<br>    }</p><p>    /**<br>     * POST /api/auth/profile/avatar<br>     */<br>    public function uploadAvatar(Request $request)<br>    {<br>        $request-&gt;validate([<br>            'avatar' =&gt; 'required|file|image|max:5120',<br>        ]);</p><p>        $file = $request-&gt;file('avatar');<br>        $path = $file-&gt;store('avatars', 'public');<br>        $url = asset('storage/' . $path);</p><p>        $request-&gt;user()-&gt;update(['avatar' =&gt; $url]);</p><p>        return response()-&gt;json([<br>            'avatar_url' =&gt; $url,<br>            'url' =&gt; $url,<br>            'user' =&gt; $request-&gt;user()-&gt;fresh(),<br>        ]);<br>    }</p><p>    /**<br>     * PUT /api/auth/profile/password<br>     */<br>    public function changePassword(Request $request)<br>    {<br>        $request-&gt;validate([<br>            'current_password' =&gt; 'required|string',<br>            'password' =&gt; 'required|string|min:6',<br>            'password_confirmation' =&gt; 'required|string|same:password',<br>        ]);</p><p>        $user = $request-&gt;user();</p><p>        if (!Hash::check($request-&gt;current_password, $user-&gt;password)) {<br>            throw ValidationException::withMessages([<br>                'current_password' =&gt; ['Current password is incorrect.'],<br>            ]);<br>        }</p><p>        $user-&gt;update(['password' =&gt; $request-&gt;password]);<br>        return response()-&gt;json(['message' =&gt; 'Password updated successfully.']);<br>    }</p><p>    /**<br>     * POST /api/auth/verify-email<br>     */<br>    public function verifyEmail(Request $request)<br>    {<br>        $request-&gt;validate(['code' =&gt; 'required|string|size:6']);<br>        $user = $request-&gt;user();</p><p>        if ($user-&gt;email_verified) {<br>            return response()-&gt;json(['message' =&gt; 'Email already verified.']);<br>        }</p><p>        if ($user-&gt;email_verification_code !== $request-&gt;code) {<br>            throw ValidationException::withMessages([<br>                'code' =&gt; ['Invalid verification code.'],<br>            ]);<br>        }</p><p>        $user-&gt;update([<br>            'email_verified' =&gt; true,<br>            'email_verification_code' =&gt; null,<br>        ]);</p><p>        return response()-&gt;json(['message' =&gt; 'Email verified successfully.', 'user' =&gt; $user-&gt;fresh()]);<br>    }</p><p>    /**<br>     * POST /api/auth/resend-verification<br>     */<br>    public function resendVerification(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        if ($user-&gt;email_verified) {<br>            return response()-&gt;json(['message' =&gt; 'Email already verified.']);<br>        }</p><p>        $code = str_pad(random_int(0, 999999), 6, '0', STR_PAD_LEFT);<br>        $user-&gt;update(['email_verification_code' =&gt; $code]);</p><p>        try {<br>            Mail::to($user-&gt;email)-&gt;send(new VerificationCodeMail($code, $user-&gt;fullname));<br>        } catch (\Throwable $e) {<br>            \Log::warning('Resend verification email failed: ' . $e-&gt;getMessage());<br>        }</p><p>        return response()-&gt;json(['message' =&gt; 'Verification code resent.']);<br>    }</p><p>    /**<br>     * POST /api/auth/verify-mobile<br>     */<br>    public function verifyMobile(Request $request)<br>    {<br>        $request-&gt;validate(['code' =&gt; 'required|string']);<br>        $user = $request-&gt;user();<br>        $user-&gt;update(['mobile_verified' =&gt; true]);<br>        return response()-&gt;json(['message' =&gt; 'Mobile verified successfully.']);<br>    }</p><p>    /**<br>     * POST /api/auth/forgot-password<br>     */<br>    public function forgotPassword(Request $request)<br>    {<br>        $request-&gt;validate(['email' =&gt; 'required|email']);<br>        $user = User::where('email', $request-&gt;email)-&gt;where('is_active', true)-&gt;first();</p><p>        if (!$user) {<br>            return response()-&gt;json(['message' =&gt; 'If this email exists, a reset code has been sent.']);<br>        }</p><p>        $code = str_pad(random_int(0, 999999), 6, '0', STR_PAD_LEFT);<br>        $user-&gt;update([<br>            'password_reset_code' =&gt; $code,<br>            'password_reset_expires_at' =&gt; now()-&gt;addMinutes(15),<br>        ]);</p><p>        try {<br>            Mail::to($user-&gt;email)-&gt;send(new PasswordResetMail($code, $user-&gt;fullname));<br>        } catch (\Throwable $e) {<br>            \Log::warning('Password reset email failed: ' . $e-&gt;getMessage());<br>        }</p><p>        return response()-&gt;json(['message' =&gt; 'If this email exists, a reset code has been sent.']);<br>    }</p><p>    /**<br>     * POST /api/auth/reset-password<br>     */<br>    public function resetPassword(Request $request)<br>    {<br>        $request-&gt;validate([<br>            'email' =&gt; 'required|email',<br>            'code' =&gt; 'required|string|size:6',<br>            'password' =&gt; 'required|string|min:6',<br>        ]);</p><p>        $user = User::where('email', $request-&gt;email)-&gt;where('is_active', true)-&gt;first();</p><p>        if (!$user) {<br>            throw ValidationException::withMessages(['email' =&gt; ['User not found.']]);<br>        }</p><p>        if (!$user-&gt;password_reset_code || $user-&gt;password_reset_code !== $request-&gt;code) {<br>            throw ValidationException::withMessages(['code' =&gt; ['Invalid reset code.']]);<br>        }</p><p>        if ($user-&gt;password_reset_expires_at &amp;&amp; now()-&gt;gt($user-&gt;password_reset_expires_at)) {<br>            throw ValidationException::withMessages(['code' =&gt; ['Reset code has expired.']]);<br>        }</p><p>        $user-&gt;update([<br>            'password' =&gt; $request-&gt;password,<br>            'password_reset_code' =&gt; null,<br>            'password_reset_expires_at' =&gt; null,<br>        ]);</p><p>        return response()-&gt;json(['message' =&gt; 'Password reset successfully.']);<br>    }</p><p>    /**<br>     * DELETE /api/auth/profile — Account deletion (GDPR Art. 17)<br>     */<br>    public function deleteAccount(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        $user-&gt;update([<br>            'is_active' =&gt; false,<br>            'email' =&gt; 'deleted_' . $user-&gt;id . '@removed.medagama.com',<br>            'fullname' =&gt; 'Deleted User',<br>            'avatar' =&gt; null,<br>            'mobile' =&gt; null,<br>            'mobile_verified' =&gt; false,<br>            'email_verified' =&gt; false,<br>        ]);</p><p>        $user-&gt;tokens()-&gt;delete();</p><p>        MedStreamPost::where('author_id', $user-&gt;id)-&gt;update(['is_active' =&gt; false]);<br>        MedStreamComment::where('author_id', $user-&gt;id)-&gt;update(['is_active' =&gt; false]);<br>        MedStreamLike::where('user_id', $user-&gt;id)-&gt;update(['is_active' =&gt; false]);<br>        MedStreamBookmark::where('user_id', $user-&gt;id)-&gt;update(['is_active' =&gt; false]);</p><p>        \Log::info('GDPR: Account deleted (soft)', ['user_id' =&gt; $user-&gt;id]);</p><p>        return response()-&gt;json(['message' =&gt; 'Account and data deleted successfully.']);<br>    }</p><p>    /**<br>     * GET /api/auth/profile/data-export — GDPR data portability (Art. 20)<br>     */<br>    public function dataExport(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        $export = [<br>            'export_date' =&gt; now()-&gt;toISOString(),<br>            'gdpr_export' =&gt; true,<br>            'user' =&gt; [<br>                'id' =&gt; $user-&gt;id,<br>                'fullname' =&gt; $user-&gt;fullname,<br>                'email' =&gt; $user-&gt;email,<br>                'mobile' =&gt; $user-&gt;mobile,<br>                'role' =&gt; $user-&gt;role_id,<br>                'avatar' =&gt; $user-&gt;avatar,<br>                'created_at' =&gt; $user-&gt;created_at,<br>                'last_login' =&gt; $user-&gt;last_login,<br>            ],<br>            'posts' =&gt; $user-&gt;medStreamPosts()-&gt;select('id', 'content', 'post_type', 'media_url', 'created_at')-&gt;get(),<br>            'comments' =&gt; MedStreamComment::where('author_id', $user-&gt;id)-&gt;select('id', 'post_id', 'content', 'created_at')-&gt;get(),<br>            'likes' =&gt; MedStreamLike::where('user_id', $user-&gt;id)-&gt;where('is_active', true)-&gt;select('post_id', 'created_at')-&gt;get(),<br>            'bookmarks' =&gt; $user-&gt;bookmarks()-&gt;where('is_active', true)-&gt;select('bookmarked_type', 'target_id', 'created_at')-&gt;get(),<br>            'medical_history' =&gt; json_decode($user-&gt;medical_history ?? '[]', true),<br>        ];</p><p>        return response()-&gt;json($export);<br>    }</p><p>    /**<br>     * GET /api/auth/profile/medical-history<br>     */<br>    public function getMedicalHistory(Request $request)<br>    {<br>        $user = $request-&gt;user();<br>        $conditions = json_decode($user-&gt;medical_history ?? '[]', true);<br>        return response()-&gt;json(['conditions' =&gt; $conditions]);<br>    }</p><p>    /**<br>     * PUT /api/auth/profile/medical-history<br>     */<br>    public function updateMedicalHistory(Request $request)<br>    {<br>        $request-&gt;validate([<br>            'conditions' =&gt; 'required|array',<br>            'conditions.*' =&gt; 'string|max:255',<br>        ]);</p><p>        $request-&gt;user()-&gt;update([<br>            'medical_history' =&gt; json_encode($request-&gt;conditions),<br>        ]);</p><p>        return response()-&gt;json(['message' =&gt; 'Medical history updated.', 'conditions' =&gt; $request-&gt;conditions]);<br>    }</p><p>    /**<br>     * GET /api/auth/profile/notification-preferences<br>     */<br>    public function getNotificationPrefs(Request $request)<br>    {<br>        $user = $request-&gt;user();<br>        $prefs = json_decode($user-&gt;notification_preferences ?? '{}', true);<br>        return response()-&gt;json(['preferences' =&gt; $prefs]);<br>    }</p><p>    /**<br>     * PUT /api/auth/profile/notification-preferences<br>     */<br>    public function updateNotificationPrefs(Request $request)<br>    {<br>        $request-&gt;validate([<br>            'email_notifications' =&gt; 'sometimes|boolean',<br>            'sms_notifications' =&gt; 'sometimes|boolean',<br>            'push_notifications' =&gt; 'sometimes|boolean',<br>            'appointment_reminders' =&gt; 'sometimes|boolean',<br>            'marketing_messages' =&gt; 'sometimes|boolean',<br>        ]);</p><p>        $request-&gt;user()-&gt;update([<br>            'notification_preferences' =&gt; json_encode($request-&gt;only([<br>                'email_notifications', 'sms_notifications', 'push_notifications',<br>                'appointment_reminders', 'marketing_messages',<br>            ])),<br>        ]);</p><p>        return response()-&gt;json(['message' =&gt; 'Notification preferences updated.']);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.2 DoctorProfileController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/DoctorProfileController.php`  <br><strong>Route Prefix:</strong> `/api/doctor-profile`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\DoctorProfile;<br>use Illuminate\Http\Request;</p><p>class DoctorProfileController extends Controller<br>{<br>    /**<br>     * GET /api/doctor-profile<br>     */<br>    public function show(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        if (!in_array($user-&gt;role_id, ['doctor', 'clinicOwner', 'superAdmin'])) {<br>            return response()-&gt;json(['message' =&gt; 'Not a doctor'], 403);<br>        }</p><p>        $profile = DoctorProfile::where('user_id', $user-&gt;id)-&gt;first();</p><p>        if (!$profile) {<br>            $profile = DoctorProfile::create([<br>                'user_id' =&gt; $user-&gt;id,<br>                'onboarding_step' =&gt; 0,<br>                'onboarding_completed' =&gt; false,<br>            ]);<br>        }</p><p>        return response()-&gt;json([<br>            'profile' =&gt; $profile,<br>            'user' =&gt; [<br>                'id' =&gt; $user-&gt;id,<br>                'fullname' =&gt; $user-&gt;fullname,<br>                'avatar' =&gt; $user-&gt;avatar,<br>                'email' =&gt; $user-&gt;email,<br>                'role_id' =&gt; $user-&gt;role_id,<br>            ],<br>        ]);<br>    }</p><p>    /**<br>     * PUT /api/doctor-profile<br>     */<br>    public function update(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        if (!in_array($user-&gt;role_id, ['doctor', 'clinicOwner', 'superAdmin'])) {<br>            return response()-&gt;json(['message' =&gt; 'Not a doctor'], 403);<br>        }</p><p>        $validated = $request-&gt;validate([<br>            'title'              =&gt; 'nullable|string|max:255',<br>            'specialty'          =&gt; 'nullable|string|max:255',<br>            'sub_specialties'    =&gt; 'nullable|array',<br>            'bio'                =&gt; 'nullable|string|max:5000',<br>            'experience_years'   =&gt; 'nullable|string|max:50',<br>            'license_number'     =&gt; 'nullable|string|max:100',<br>            'education'          =&gt; 'nullable|array',<br>            'education.*.degree' =&gt; 'required_with:education|string',<br>            'education.*.school' =&gt; 'required_with:education|string',<br>            'education.*.year'   =&gt; 'nullable|string',<br>            'certifications'       =&gt; 'nullable|array',<br>            'certifications.*.name'   =&gt; 'required_with:certifications|string',<br>            'certifications.*.issuer' =&gt; 'nullable|string',<br>            'certifications.*.year'   =&gt; 'nullable|string',<br>            'services'             =&gt; 'nullable|array',<br>            'services.*.name'        =&gt; 'required_with:services|string',<br>            'services.*.description' =&gt; 'nullable|string',<br>            'prices'               =&gt; 'nullable|array',<br>            'prices.*.label'       =&gt; 'required_with:prices|string',<br>            'prices.*.min'         =&gt; 'nullable|numeric',<br>            'prices.*.max'         =&gt; 'nullable|numeric',<br>            'prices.*.currency'    =&gt; 'nullable|string|max:10',<br>            'languages'          =&gt; 'nullable|array',<br>            'address'            =&gt; 'nullable|string|max:500',<br>            'map_coordinates'    =&gt; 'nullable|array',<br>            'phone'              =&gt; 'nullable|string|max:50',<br>            'website'            =&gt; 'nullable|string|max:255',<br>            'gallery'            =&gt; 'nullable|array',<br>            'online_consultation'  =&gt; 'nullable|boolean',<br>            'accepts_insurance'    =&gt; 'nullable|boolean',<br>            'insurance_providers'  =&gt; 'nullable|array',<br>            'onboarding_step'      =&gt; 'nullable|integer|min:0|max:10',<br>            'onboarding_completed' =&gt; 'nullable|boolean',<br>        ]);</p><p>        $profile = DoctorProfile::firstOrCreate(<br>            ['user_id' =&gt; $user-&gt;id],<br>            ['onboarding_step' =&gt; 0, 'onboarding_completed' =&gt; false]<br>        );</p><p>        $profile-&gt;update($validated);</p><p>        return response()-&gt;json([<br>            'profile' =&gt; $profile-&gt;fresh(),<br>            'message' =&gt; 'Profile updated successfully',<br>        ]);<br>    }</p><p>    /**<br>     * PUT /api/doctor-profile/onboarding<br>     */<br>    public function updateOnboarding(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        if (!in_array($user-&gt;role_id, ['doctor', 'clinicOwner', 'superAdmin'])) {<br>            return response()-&gt;json(['message' =&gt; 'Not a doctor'], 403);<br>        }</p><p>        $profile = DoctorProfile::firstOrCreate(<br>            ['user_id' =&gt; $user-&gt;id],<br>            ['onboarding_step' =&gt; 0, 'onboarding_completed' =&gt; false]<br>        );</p><p>        $step = $request-&gt;input('step', $profile-&gt;onboarding_step);<br>        $data = $request-&gt;except(['step']);</p><p>        $profile-&gt;fill($data);<br>        $profile-&gt;onboarding_step = max($profile-&gt;onboarding_step, $step + 1);</p><p>        if ($step &gt;= 3) {<br>            $profile-&gt;onboarding_completed = true;<br>        }</p><p>        $profile-&gt;save();</p><p>        return response()-&gt;json([<br>            'profile' =&gt; $profile-&gt;fresh(),<br>            'message' =&gt; 'Onboarding step saved',<br>        ]);<br>    }</p><p>    /**<br>     * POST /api/doctor-profile/gallery<br>     */<br>    public function uploadGallery(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        if (!in_array($user-&gt;role_id, ['doctor', 'clinicOwner', 'superAdmin'])) {<br>            return response()-&gt;json(['message' =&gt; 'Not a doctor'], 403);<br>        }</p><p>        $request-&gt;validate([<br>            'images'   =&gt; 'required|array|max:10',<br>            'images.*' =&gt; 'file|mimes:jpg,jpeg,png,webp|max:5120',<br>        ]);</p><p>        $profile = DoctorProfile::firstOrCreate(<br>            ['user_id' =&gt; $user-&gt;id],<br>            ['onboarding_step' =&gt; 0, 'onboarding_completed' =&gt; false]<br>        );</p><p>        $gallery = $profile-&gt;gallery ?? [];</p><p>        foreach ($request-&gt;file('images') as $image) {<br>            $path = $image-&gt;store('doctor-gallery/' . $user-&gt;id, 'public');<br>            $gallery[] = '/storage/' . $path;<br>        }</p><p>        $profile-&gt;update(['gallery' =&gt; $gallery]);</p><p>        return response()-&gt;json([<br>            'gallery' =&gt; $gallery,<br>            'message' =&gt; 'Gallery updated',<br>        ]);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.3 DoctorController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/DoctorController.php`  <br><strong>Route Prefix:</strong> `/api/doctors`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\User;<br>use Illuminate\Http\Request;</p><p>class DoctorController extends Controller<br>{<br>    /**<br>     * GET /api/doctors<br>     */<br>    public function index(Request $request)<br>    {<br>        $query = User::where('role_id', 'doctor')<br>            -&gt;where('is_active', true)<br>            -&gt;with(['doctorProfile:id,user_id,title,specialty,experience_years,address,online_consultation,bio'])<br>            -&gt;select('id', 'fullname', 'avatar', 'email', 'city_id', 'country_id', 'clinic_id', 'is_verified');</p><p>        $query-&gt;when($request-&gt;clinic_id, fn($q, $v) =&gt; $q-&gt;where('clinic_id', $v))<br>              -&gt;when($request-&gt;city_id, fn($q, $v) =&gt; $q-&gt;where('city_id', $v))<br>              -&gt;when($request-&gt;search, fn($q, $v) =&gt; $q-&gt;where('fullname', 'like', "%{$v}%"))<br>              -&gt;when($request-&gt;specialty, fn($q, $v) =&gt; $q-&gt;whereHas('doctorProfile', fn($pq) =&gt; $pq-&gt;where('specialty', 'ilike', "%{$v}%")));</p><p>        $doctors = $query-&gt;orderBy('fullname')-&gt;paginate($request-&gt;per_page ?? 50);</p><p>        return response()-&gt;json($doctors);<br>    }</p><p>    /**<br>     * GET /api/doctors/{id}<br>     */<br>    public function show(string $id)<br>    {<br>        $doctor = User::where('role_id', 'doctor')<br>            -&gt;where('is_active', true)<br>            -&gt;with(['doctorProfile', 'clinic:id,name,codename,avatar,address'])<br>            -&gt;select('id', 'fullname', 'avatar', 'email', 'city_id', 'country_id', 'clinic_id', 'is_verified', 'gender')<br>            -&gt;findOrFail($id);</p><p>        return response()-&gt;json(['doctor' =&gt; $doctor]);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.4 ClinicController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/ClinicController.php`  <br><strong>Route Prefix:</strong> `/api/clinics`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\Clinic;<br>use App\Models\User;<br>use Illuminate\Http\Request;<br>use Illuminate\Support\Str;</p><p>class ClinicController extends Controller<br>{<br>    public function index(Request $request)<br>    {<br>        $clinics = Clinic::active()<br>            -&gt;when($request-&gt;name, fn($q, $v) =&gt; $q-&gt;where('fullname', 'like', "%{$v}%"))<br>            -&gt;select('id', 'name', 'codename', 'fullname', 'avatar', 'address', 'is_verified')<br>            -&gt;paginate($request-&gt;per_page ?? 20);</p><p>        return response()-&gt;json($clinics);<br>    }</p><p>    public function show(string $codename)<br>    {<br>        $clinic = Clinic::active()-&gt;where('codename', $codename)-&gt;firstOrFail();<br>        return response()-&gt;json(['clinic' =&gt; $clinic-&gt;load('owner:id,fullname,avatar')]);<br>    }</p><p>    public function store(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'name' =&gt; 'required|string|max:100',<br>            'fullname' =&gt; 'required|string|max:255',<br>            'owner_id' =&gt; 'required|uuid|exists:users,id',<br>            'address' =&gt; 'sometimes|string',<br>            'biography' =&gt; 'sometimes|string',<br>            'map_coordinates' =&gt; 'sometimes|array',<br>            'website' =&gt; 'sometimes|url',<br>        ]);</p><p>        $validated['codename'] = Str::slug($validated['name']) . '-' . Str::random(4);<br>        $validated['avatar'] = 'https://gravatar.com/avatar/' . md5(strtolower($validated['fullname'])) . '?s=200&amp;d=identicon';</p><p>        $clinic = Clinic::create($validated);</p><p>        User::where('id', $validated['owner_id'])-&gt;update([<br>            'role_id' =&gt; 'clinicOwner',<br>            'clinic_id' =&gt; $clinic-&gt;id,<br>        ]);</p><p>        return response()-&gt;json(['clinic' =&gt; $clinic], 201);<br>    }</p><p>    public function update(Request $request, string $id)<br>    {<br>        $clinic = Clinic::active()-&gt;findOrFail($id);<br>        $user = $request-&gt;user();</p><p>        if ($clinic-&gt;owner_id !== $user-&gt;id &amp;&amp; !$user-&gt;isAdmin()) {<br>            return response()-&gt;json(['message' =&gt; 'Forbidden.'], 403);<br>        }</p><p>        $validated = $request-&gt;validate([<br>            'name' =&gt; 'sometimes|string|max:100',<br>            'fullname' =&gt; 'sometimes|string|max:255',<br>            'avatar' =&gt; 'sometimes|string|url',<br>            'address' =&gt; 'sometimes|string',<br>            'biography' =&gt; 'sometimes|string',<br>            'map_coordinates' =&gt; 'sometimes|array',<br>            'website' =&gt; 'sometimes|url',<br>        ]);</p><p>        $clinic-&gt;update($validated);<br>        return response()-&gt;json(['clinic' =&gt; $clinic-&gt;fresh()]);<br>    }</p><p>    public function staff(Request $request, string $id)<br>    {<br>        $clinic = Clinic::active()-&gt;findOrFail($id);</p><p>        $staff = User::active()<br>            -&gt;where('clinic_id', $clinic-&gt;id)<br>            -&gt;with('doctorProfile:id,user_id,title,specialty,experience_years,onboarding_completed')<br>            -&gt;select('id', 'fullname', 'email', 'avatar', 'role_id', 'is_verified', 'clinic_id', 'created_at')<br>            -&gt;paginate($request-&gt;per_page ?? 50);</p><p>        return response()-&gt;json($staff);<br>    }</p><p>    public function createStaff(Request $request, string $id)<br>    {<br>        $clinic = Clinic::active()-&gt;findOrFail($id);<br>        $user = $request-&gt;user();</p><p>        if ($clinic-&gt;owner_id !== $user-&gt;id &amp;&amp; !$user-&gt;isAdmin()) {<br>            return response()-&gt;json(['message' =&gt; 'Forbidden.'], 403);<br>        }</p><p>        $validated = $request-&gt;validate([<br>            'fullname'  =&gt; 'required|string|max:255',<br>            'email'     =&gt; 'required|email|max:255',<br>            'password'  =&gt; 'required|string|min:6|max:100',<br>            'mobile'    =&gt; 'nullable|string|max:20',<br>            'title'     =&gt; 'nullable|string|max:255',<br>            'specialty' =&gt; 'nullable|string|max:255',<br>            'bio'       =&gt; 'nullable|string|max:5000',<br>            'experience_years' =&gt; 'nullable|string|max:50',<br>        ]);</p><p>        $exists = User::where('email', $validated['email'])-&gt;where('clinic_id', $clinic-&gt;id)-&gt;exists();<br>        if ($exists) {<br>            return response()-&gt;json(['message' =&gt; 'A user with this email already exists in this clinic.'], 422);<br>        }</p><p>        $doctor = User::create([<br>            'fullname'       =&gt; $validated['fullname'],<br>            'email'          =&gt; $validated['email'],<br>            'password'       =&gt; bcrypt($validated['password']),<br>            'mobile'         =&gt; $validated['mobile'] ?? null,<br>            'role_id'        =&gt; 'doctor',<br>            'clinic_id'      =&gt; $clinic-&gt;id,<br>            'is_active'      =&gt; true,<br>            'email_verified' =&gt; true,<br>        ]);</p><p>        $profileFields = array_filter([<br>            'title'            =&gt; $validated['title'] ?? null,<br>            'specialty'        =&gt; $validated['specialty'] ?? null,<br>            'bio'              =&gt; $validated['bio'] ?? null,<br>            'experience_years' =&gt; $validated['experience_years'] ?? null,<br>        ]);</p><p>        if (!empty($profileFields)) {<br>            $doctor-&gt;doctorProfile()-&gt;create(array_merge($profileFields, [<br>                'onboarding_completed' =&gt; false,<br>                'onboarding_step'      =&gt; 0,<br>            ]));<br>        }</p><p>        return response()-&gt;json([<br>            'doctor'  =&gt; $doctor-&gt;load('doctorProfile'),<br>            'message' =&gt; 'Doctor account created successfully.',<br>        ], 201);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.5 — 2.14 Diğer Controller'lar</h2></p><p>&gt; Dosya çok uzun olduğu için kalan controller'lar (AppointmentController, CalendarSlotController, MedStreamController, MessageController, NotificationController, CatalogController, CrmController, DigitalAnamnesisController, PatientRecordController, MediaStreamController) ayrı bir dokümanda devam eder.</p><p><hr style="margin:30px 0"></p><p><h1 style="color:#0d9488;margin-top:40px">BÖLÜM 3: ROUTES</h1></p><p><strong>Dosya:</strong> `routes/api.php`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>use Illuminate\Support\Facades\Route;<br>use App\Http\Controllers\Api\AuthController;<br>use App\Http\Controllers\Api\ClinicController;<br>use App\Http\Controllers\Api\AppointmentController;<br>use App\Http\Controllers\Api\CalendarSlotController;<br>use App\Http\Controllers\Api\PatientRecordController;<br>use App\Http\Controllers\Api\DigitalAnamnesisController;<br>use App\Http\Controllers\Api\CrmController;<br>use App\Http\Controllers\Api\MedStreamController;<br>use App\Http\Controllers\Api\CatalogController;<br>use App\Http\Controllers\Api\DoctorController;<br>use App\Http\Controllers\Api\DoctorProfileController;<br>use App\Http\Controllers\Api\MessageController;<br>use App\Http\Controllers\Api\NotificationController;<br>use App\Http\Controllers\Api\MediaStreamController;</p><p>// ── Auth (Public) ──<br>Route::prefix('auth')-&gt;group(function () {<br>    Route::post('/register', [AuthController::class, 'register']);<br>    Route::post('/login', [AuthController::class, 'login']);<br>    Route::post('/forgot-password', [AuthController::class, 'forgotPassword']);<br>    Route::post('/reset-password', [AuthController::class, 'resetPassword']);<br>});</p><p>// ── Auth (Protected) ──<br>Route::prefix('auth')-&gt;middleware('auth:sanctum')-&gt;group(function () {<br>    Route::post('/logout', [AuthController::class, 'logout']);<br>    Route::get('/me', [AuthController::class, 'me']);<br>    Route::put('/profile', [AuthController::class, 'updateProfile']);<br>    Route::post('/profile/avatar', [AuthController::class, 'uploadAvatar']);<br>    Route::put('/profile/password', [AuthController::class, 'changePassword']);<br>    Route::delete('/profile', [AuthController::class, 'deleteAccount']);<br>    Route::get('/profile/data-export', [AuthController::class, 'dataExport']);<br>    Route::get('/profile/medical-history', [AuthController::class, 'getMedicalHistory']);<br>    Route::put('/profile/medical-history', [AuthController::class, 'updateMedicalHistory']);<br>    Route::get('/profile/notification-preferences', [AuthController::class, 'getNotificationPrefs']);<br>    Route::put('/profile/notification-preferences', [AuthController::class, 'updateNotificationPrefs']);<br>    Route::post('/verify-email', [AuthController::class, 'verifyEmail']);<br>    Route::post('/resend-verification', [AuthController::class, 'resendVerification']);<br>    Route::post('/verify-mobile', [AuthController::class, 'verifyMobile']);<br>});</p><p>// ── Catalog (Public read) ──<br>Route::prefix('catalog')-&gt;group(function () {<br>    Route::get('/specialties', [CatalogController::class, 'specialties']);<br>    Route::get('/cities', [CatalogController::class, 'cities']);<br>    Route::get('/diseases', [CatalogController::class, 'diseases']);<br>    Route::get('/symptoms', [CatalogController::class, 'symptoms']);<br>});</p><p>// ── Catalog (Admin write) ──<br>Route::prefix('catalog')-&gt;middleware(['auth:sanctum', 'role:superAdmin,saasAdmin'])-&gt;group(function () {<br>    Route::post('/specialties', [CatalogController::class, 'storeSpecialty']);<br>    Route::put('/specialties/{id}', [CatalogController::class, 'updateSpecialty']);<br>    Route::delete('/specialties/{id}', [CatalogController::class, 'destroySpecialty']);<br>    Route::post('/cities', [CatalogController::class, 'storeCity']);<br>    Route::put('/cities/{id}', [CatalogController::class, 'updateCity']);<br>    Route::delete('/cities/{id}', [CatalogController::class, 'destroyCity']);<br>    Route::post('/diseases', [CatalogController::class, 'storeDisease']);<br>    Route::put('/diseases/{id}', [CatalogController::class, 'updateDisease']);<br>    Route::post('/symptoms', [CatalogController::class, 'storeSymptom']);<br>    Route::put('/symptoms/{id}', [CatalogController::class, 'updateSymptom']);<br>});</p><p>// ── Clinics ──<br>Route::get('/clinics', [ClinicController::class, 'index']);<br>Route::get('/clinics/{codename}', [ClinicController::class, 'show']);<br>Route::middleware('auth:sanctum')-&gt;group(function () {<br>    Route::post('/clinics', [ClinicController::class, 'store'])-&gt;middleware('role:superAdmin,saasAdmin');<br>    Route::put('/clinics/{id}', [ClinicController::class, 'update']);<br>    Route::get('/clinics/{id}/staff', [ClinicController::class, 'staff']);<br>    Route::post('/clinics/{id}/staff', [ClinicController::class, 'createStaff']);<br>});</p><p>// ── Doctors (Public) ──<br>Route::get('/doctors', [DoctorController::class, 'index']);<br>Route::get('/doctors/{id}', [DoctorController::class, 'show']);</p><p>// ── Doctor Profile (Protected) ──<br>Route::prefix('doctor-profile')-&gt;middleware('auth:sanctum')-&gt;group(function () {<br>    Route::get('/', [DoctorProfileController::class, 'show']);<br>    Route::put('/', [DoctorProfileController::class, 'update']);<br>    Route::put('/onboarding', [DoctorProfileController::class, 'updateOnboarding']);<br>    Route::post('/gallery', [DoctorProfileController::class, 'uploadGallery']);<br>});</p><p>// ── Appointments (Protected) ──<br>Route::middleware('auth:sanctum')-&gt;group(function () {<br>    Route::apiResource('appointments', AppointmentController::class);<br>});</p><p>// ── Calendar Slots (Protected) ──<br>Route::middleware('auth:sanctum')-&gt;group(function () {<br>    Route::get('/calendar-slots', [CalendarSlotController::class, 'index']);<br>    Route::post('/calendar-slots', [CalendarSlotController::class, 'store'])-&gt;middleware('role:doctor,clinicOwner,superAdmin');<br>    Route::post('/calendar-slots/bulk', [CalendarSlotController::class, 'bulkStore'])-&gt;middleware('role:doctor,clinicOwner,superAdmin');<br>    Route::put('/calendar-slots/{id}', [CalendarSlotController::class, 'update'])-&gt;middleware('role:doctor,clinicOwner,superAdmin');<br>    Route::delete('/calendar-slots/{id}', [CalendarSlotController::class, 'destroy'])-&gt;middleware('role:doctor,clinicOwner,superAdmin');<br>});</p><p>// ── Patient Records (Protected) ──<br>Route::middleware('auth:sanctum')-&gt;group(function () {<br>    Route::get('/patient-records', [PatientRecordController::class, 'index']);<br>    Route::get('/patient-records/{id}', [PatientRecordController::class, 'show']);<br>    Route::post('/patient-records', [PatientRecordController::class, 'store'])-&gt;middleware('role:doctor,clinicOwner,superAdmin');<br>    Route::delete('/patient-records/{id}', [PatientRecordController::class, 'destroy'])-&gt;middleware('role:doctor,clinicOwner,superAdmin');<br>});</p><p>// ── Digital Anamnesis (Protected) ──<br>Route::middleware('auth:sanctum')-&gt;group(function () {<br>    Route::get('/anamnesis/{patientId}', [DigitalAnamnesisController::class, 'show']);<br>    Route::post('/anamnesis', [DigitalAnamnesisController::class, 'upsert']);<br>});</p><p>// ── CRM (Protected — doctor/clinicOwner) ──<br>Route::prefix('crm')-&gt;middleware(['auth:sanctum', 'role:doctor,clinicOwner,superAdmin'])-&gt;group(function () {<br>    Route::get('/tags', [CrmController::class, 'tags']);<br>    Route::post('/tags', [CrmController::class, 'storeTag']);<br>    Route::delete('/tags/{id}', [CrmController::class, 'destroyTag']);<br>    Route::get('/stages', [CrmController::class, 'stages']);<br>    Route::post('/stages', [CrmController::class, 'storeStage']);<br>    Route::put('/stages/{id}', [CrmController::class, 'updateStage']);<br>    Route::get('/archived-records', [CrmController::class, 'archivedRecords']);<br>    Route::post('/archived-records', [CrmController::class, 'storeArchivedRecord']);<br>});</p><p>// ── MedStream ──<br>Route::prefix('medstream')-&gt;group(function () {<br>    Route::get('/posts', [MedStreamController::class, 'posts']);<br>    Route::get('/posts/{id}', [MedStreamController::class, 'showPost']);<br>    Route::get('/posts/{postId}/comments', [MedStreamController::class, 'comments']);</p><p>    Route::middleware('auth:sanctum')-&gt;group(function () {<br>        Route::post('/posts', [MedStreamController::class, 'storePost']);<br>        Route::put('/posts/{id}', [MedStreamController::class, 'updatePost']);<br>        Route::delete('/posts/{id}', [MedStreamController::class, 'destroyPost']);<br>        Route::post('/posts/{postId}/comments', [MedStreamController::class, 'storeComment']);<br>        Route::post('/posts/{postId}/like', [MedStreamController::class, 'toggleLike']);<br>        Route::post('/posts/{postId}/report', [MedStreamController::class, 'storeReport']);<br>        Route::get('/bookmarks', [MedStreamController::class, 'bookmarks']);<br>        Route::post('/bookmarks', [MedStreamController::class, 'toggleBookmark']);<br>    });</p><p>    Route::middleware(['auth:sanctum', 'role:superAdmin,saasAdmin'])-&gt;group(function () {<br>        Route::get('/reports', [MedStreamController::class, 'reports']);<br>        Route::put('/reports/{id}', [MedStreamController::class, 'updateReport']);<br>    });<br>});</p><p>// ── Messaging ──<br>Route::prefix('messages')-&gt;middleware('auth:sanctum')-&gt;group(function () {<br>    Route::get('/conversations', [MessageController::class, 'conversations']);<br>    Route::post('/conversations', [MessageController::class, 'createConversation']);<br>    Route::get('/conversations/{id}', [MessageController::class, 'showConversation']);<br>    Route::put('/conversations/{id}', [MessageController::class, 'updateConversation']);<br>    Route::delete('/conversations/{id}', [MessageController::class, 'deleteConversation']);<br>    Route::get('/conversations/{conversationId}/messages', [MessageController::class, 'messages']);<br>    Route::post('/conversations/{conversationId}/messages', [MessageController::class, 'sendMessage']);<br>    Route::post('/conversations/{conversationId}/read', [MessageController::class, 'markRead']);<br>    Route::put('/{messageId}', [MessageController::class, 'updateMessage']);<br>    Route::delete('/{messageId}', [MessageController::class, 'deleteMessage']);<br>    Route::get('/search', [MessageController::class, 'search']);<br>    Route::get('/unread-count', [MessageController::class, 'unreadCount']);<br>});</p><p>// ── Notifications ──<br>Route::prefix('notifications')-&gt;middleware('auth:sanctum')-&gt;group(function () {<br>    Route::get('/', [NotificationController::class, 'index']);<br>    Route::get('/unread-count', [NotificationController::class, 'unreadCount']);<br>    Route::put('/{id}/read', [NotificationController::class, 'markAsRead']);<br>    Route::put('/read-all', [NotificationController::class, 'markAllAsRead']);<br>    Route::delete('/{id}', [NotificationController::class, 'destroy']);<br>    Route::delete('/', [NotificationController::class, 'destroyAll']);<br>});</p><p>// ── Media Stream (Public — video seek support) ──<br>Route::get('/media/stream/{path}', [MediaStreamController::class, 'stream'])<br>    -&gt;where('path', '.*');<br></code></pre></p><p><hr style="margin:30px 0"></p><p>*Bu doküman MedaGama backend kaynak kodunun referans kopyasıdır.*<br>*Oluşturulma tarihi: 19 Şubat 2026*</p><p><br><hr style="margin:30px 0"></p><p><h1 style="color:#0d9488;margin-top:40px">MedaGama Backend — Controller Kod Referansı (Bölüm 2)</h1></p><p><strong>Tarih:</strong> 19 Şubat 2026  <br><strong>Bu doküman `backend-code-reference.md` dosyasının devamıdır.</strong></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.5 AppointmentController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/AppointmentController.php`  <br><strong>Route Prefix:</strong> `/api/appointments`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\Appointment;<br>use App\Models\CalendarSlot;<br>use App\Models\User;<br>use Illuminate\Http\Request;<br>use App\Notifications\AppointmentBookedNotification;<br>use App\Notifications\AppointmentConfirmedNotification;<br>use App\Notifications\AppointmentCancelledNotification;</p><p>class AppointmentController extends Controller<br>{<br>    /**<br>     * GET /api/appointments<br>     */<br>    public function index(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        $query = Appointment::active()-&gt;with(['patient:id,fullname,avatar,email', 'doctor:id,fullname,avatar', 'clinic:id,fullname']);</p><p>        if ($user-&gt;isDoctor()) {<br>            $query-&gt;where('doctor_id', $user-&gt;id);<br>        } elseif ($user-&gt;isPatient()) {<br>            $query-&gt;where('patient_id', $user-&gt;id);<br>        } elseif ($user-&gt;isClinicOwner()) {<br>            $query-&gt;where('clinic_id', $user-&gt;clinic_id);<br>        }</p><p>        $query-&gt;when($request-&gt;status, fn($q, $v) =&gt; $q-&gt;where('status', $v))<br>              -&gt;when($request-&gt;date, fn($q, $v) =&gt; $q-&gt;whereDate('appointment_date', $v))<br>              -&gt;when($request-&gt;doctor_id, fn($q, $v) =&gt; $q-&gt;where('doctor_id', $v))<br>              -&gt;when($request-&gt;patient_id, fn($q, $v) =&gt; $q-&gt;where('patient_id', $v));</p><p>        $appointments = $query-&gt;orderBy('appointment_date', 'desc')<br>            -&gt;orderBy('appointment_time', 'desc')<br>            -&gt;paginate($request-&gt;per_page ?? 20);</p><p>        return response()-&gt;json($appointments);<br>    }</p><p>    /**<br>     * GET /api/appointments/{id}<br>     */<br>    public function show(Request $request, string $id)<br>    {<br>        $appointment = Appointment::active()<br>            -&gt;with(['patient:id,fullname,avatar,email,mobile', 'doctor:id,fullname,avatar', 'clinic:id,fullname', 'slot'])<br>            -&gt;findOrFail($id);</p><p>        return response()-&gt;json(['appointment' =&gt; $appointment]);<br>    }</p><p>    /**<br>     * POST /api/appointments<br>     */<br>    public function store(Request $request)<br>    {<br>        $user = $request-&gt;user();<br>        $isDoctor = in_array($user-&gt;role_id, ['doctor', 'clinicOwner']);</p><p>        $rules = [<br>            'doctor_id' =&gt; 'required|uuid|exists:users,id',<br>            'clinic_id' =&gt; 'sometimes|uuid|exists:clinics,id',<br>            'appointment_type' =&gt; 'required|in:inPerson,online',<br>            'slot_id' =&gt; 'sometimes|uuid|exists:calendar_slots,id',<br>            'appointment_date' =&gt; 'required|date|after_or_equal:today',<br>            'appointment_time' =&gt; 'required|string',<br>            'confirmation_note' =&gt; 'sometimes|string|max:500',<br>        ];</p><p>        if ($isDoctor) {<br>            $rules['patient_id'] = 'sometimes|uuid|exists:users,id';<br>            $rules['patient_name'] = 'required|string|max:255';<br>            $rules['patient_email'] = 'required|email|max:255';<br>            $rules['patient_phone'] = 'sometimes|string|max:50';<br>            $rules['patient_dob'] = 'sometimes|date';<br>        } else {<br>            $rules['patient_id'] = 'required|uuid|exists:users,id';<br>        }</p><p>        $validated = $request-&gt;validate($rules);</p><p>        if ($isDoctor &amp;&amp; empty($validated['patient_id'])) {<br>            $patient = User::where('email', $validated['patient_email'])-&gt;first();</p><p>            if (!$patient) {<br>                $patient = User::create([<br>                    'email' =&gt; $validated['patient_email'],<br>                    'fullname' =&gt; $validated['patient_name'],<br>                    'mobile' =&gt; $validated['patient_phone'] ?? null,<br>                    'date_of_birth' =&gt; $validated['patient_dob'] ?? null,<br>                    'role_id' =&gt; 'patient',<br>                    'password' =&gt; bcrypt(\Str::random(32)),<br>                ]);<br>            }</p><p>            $validated['patient_id'] = $patient-&gt;id;<br>        }</p><p>        $appointmentData = collect($validated)-&gt;only([<br>            'patient_id', 'doctor_id', 'clinic_id', 'appointment_type',<br>            'slot_id', 'appointment_date', 'appointment_time', 'confirmation_note',<br>        ])-&gt;toArray();</p><p>        $appointmentData['status'] = 'pending';<br>        $appointmentData['created_by'] = $user-&gt;id;</p><p>        if (!empty($appointmentData['slot_id'])) {<br>            $slot = CalendarSlot::active()-&gt;findOrFail($appointmentData['slot_id']);<br>            if (!$slot-&gt;is_available) {<br>                return response()-&gt;json(['message' =&gt; 'This time slot is no longer available.'], 422);<br>            }<br>            $slot-&gt;update(['is_available' =&gt; false]);<br>        }</p><p>        $appointment = Appointment::create($appointmentData);<br>        $appointment-&gt;load(['patient', 'doctor']);</p><p>        try {<br>            if ($appointment-&gt;patient) {<br>                $appointment-&gt;patient-&gt;notify(<br>                    new AppointmentBookedNotification($appointment, 'patient')<br>                );<br>            }<br>        } catch (\Throwable $e) {<br>            \Log::warning('Appointment booked patient notification failed: ' . $e-&gt;getMessage());<br>        }</p><p>        try {<br>            if ($appointment-&gt;doctor) {<br>                $appointment-&gt;doctor-&gt;notify(<br>                    new AppointmentBookedNotification($appointment, 'doctor')<br>                );<br>            }<br>        } catch (\Throwable $e) {<br>            \Log::warning('Appointment booked doctor notification failed: ' . $e-&gt;getMessage());<br>        }</p><p>        return response()-&gt;json([<br>            'appointment' =&gt; $appointment-&gt;load(['patient:id,fullname,avatar', 'doctor:id,fullname,avatar']),<br>        ], 201);<br>    }</p><p>    /**<br>     * PUT /api/appointments/{id}<br>     */<br>    public function update(Request $request, string $id)<br>    {<br>        $appointment = Appointment::active()-&gt;findOrFail($id);</p><p>        $validated = $request-&gt;validate([<br>            'status' =&gt; 'sometimes|in:pending,confirmed,cancelled,completed',<br>            'confirmation_note' =&gt; 'sometimes|string|max:500',<br>            'doctor_note' =&gt; 'sometimes|string',<br>            'video_conference_link' =&gt; 'sometimes|string|url',<br>        ]);</p><p>        $oldStatus = $appointment-&gt;status;<br>        $appointment-&gt;update($validated);<br>        $appointment-&gt;load(['patient', 'doctor']);</p><p>        if (isset($validated['status']) &amp;&amp; $validated['status'] === 'cancelled' &amp;&amp; $appointment-&gt;slot_id) {<br>            CalendarSlot::where('id', $appointment-&gt;slot_id)-&gt;update(['is_available' =&gt; true]);<br>        }</p><p>        if (isset($validated['status']) &amp;&amp; $validated['status'] !== $oldStatus) {<br>            $cancelledBy = $request-&gt;user()?-&gt;isDoctor() ? 'doctor' : ($request-&gt;user()?-&gt;isPatient() ? 'patient' : 'system');</p><p>            try {<br>                if ($validated['status'] === 'confirmed') {<br>                    if ($appointment-&gt;patient) {<br>                        $appointment-&gt;patient-&gt;notify(<br>                            new AppointmentConfirmedNotification($appointment)<br>                        );<br>                    }<br>                } elseif ($validated['status'] === 'cancelled') {<br>                    if ($appointment-&gt;patient) {<br>                        $appointment-&gt;patient-&gt;notify(<br>                            new AppointmentCancelledNotification($appointment, 'patient', $cancelledBy)<br>                        );<br>                    }<br>                    if ($appointment-&gt;doctor) {<br>                        $appointment-&gt;doctor-&gt;notify(<br>                            new AppointmentCancelledNotification($appointment, 'doctor', $cancelledBy)<br>                        );<br>                    }<br>                }<br>            } catch (\Throwable $e) {<br>                \Log::warning('Appointment status notification failed: ' . $e-&gt;getMessage());<br>            }<br>        }</p><p>        return response()-&gt;json(['appointment' =&gt; $appointment-&gt;fresh()]);<br>    }</p><p>    /**<br>     * DELETE /api/appointments/{id}<br>     */<br>    public function destroy(string $id)<br>    {<br>        $appointment = Appointment::active()-&gt;findOrFail($id);</p><p>        if ($appointment-&gt;slot_id) {<br>            CalendarSlot::where('id', $appointment-&gt;slot_id)-&gt;update(['is_available' =&gt; true]);<br>        }</p><p>        $appointment-&gt;update(['is_active' =&gt; false]);</p><p>        return response()-&gt;json(['message' =&gt; 'Appointment deleted.']);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.6 CalendarSlotController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/CalendarSlotController.php`  <br><strong>Route Prefix:</strong> `/api/calendar-slots`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\CalendarSlot;<br>use Illuminate\Http\Request;</p><p>class CalendarSlotController extends Controller<br>{<br>    /**<br>     * GET /api/calendar-slots<br>     */<br>    public function index(Request $request)<br>    {<br>        $query = CalendarSlot::active()-&gt;with(['doctor:id,fullname,avatar', 'clinic:id,fullname']);</p><p>        $query-&gt;when($request-&gt;doctor_id, fn($q, $v) =&gt; $q-&gt;where('doctor_id', $v))<br>              -&gt;when($request-&gt;clinic_id, fn($q, $v) =&gt; $q-&gt;where('clinic_id', $v))<br>              -&gt;when($request-&gt;date, fn($q, $v) =&gt; $q-&gt;whereDate('slot_date', $v))<br>              -&gt;when($request-&gt;available, fn($q) =&gt; $q-&gt;available());</p><p>        $slots = $query-&gt;orderBy('slot_date')-&gt;orderBy('start_time')<br>            -&gt;paginate($request-&gt;per_page ?? 50);</p><p>        return response()-&gt;json($slots);<br>    }</p><p>    /**<br>     * POST /api/calendar-slots<br>     */<br>    public function store(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'doctor_id' =&gt; 'required|uuid|exists:users,id',<br>            'clinic_id' =&gt; 'sometimes|uuid|exists:clinics,id',<br>            'slot_date' =&gt; 'required|date|after_or_equal:today',<br>            'start_time' =&gt; 'required|string',<br>            'duration_minutes' =&gt; 'sometimes|integer|min:5|max:480',<br>        ]);</p><p>        $validated['is_available'] = true;</p><p>        $slot = CalendarSlot::create($validated);</p><p>        return response()-&gt;json(['slot' =&gt; $slot], 201);<br>    }</p><p>    /**<br>     * POST /api/calendar-slots/bulk<br>     */<br>    public function bulkStore(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'doctor_id' =&gt; 'required|uuid|exists:users,id',<br>            'clinic_id' =&gt; 'sometimes|uuid|exists:clinics,id',<br>            'slots' =&gt; 'required|array|min:1',<br>            'slots.*.slot_date' =&gt; 'required|date|after_or_equal:today',<br>            'slots.*.start_time' =&gt; 'required|string',<br>            'slots.*.duration_minutes' =&gt; 'sometimes|integer|min:5|max:480',<br>        ]);</p><p>        $created = [];<br>        foreach ($validated['slots'] as $slotData) {<br>            $created[] = CalendarSlot::create([<br>                'doctor_id' =&gt; $validated['doctor_id'],<br>                'clinic_id' =&gt; $validated['clinic_id'] ?? null,<br>                'slot_date' =&gt; $slotData['slot_date'],<br>                'start_time' =&gt; $slotData['start_time'],<br>                'duration_minutes' =&gt; $slotData['duration_minutes'] ?? 30,<br>                'is_available' =&gt; true,<br>            ]);<br>        }</p><p>        return response()-&gt;json(['slots' =&gt; $created, 'count' =&gt; count($created)], 201);<br>    }</p><p>    /**<br>     * PUT /api/calendar-slots/{id}<br>     */<br>    public function update(Request $request, string $id)<br>    {<br>        $slot = CalendarSlot::active()-&gt;findOrFail($id);</p><p>        $validated = $request-&gt;validate([<br>            'slot_date' =&gt; 'sometimes|date',<br>            'start_time' =&gt; 'sometimes|string',<br>            'duration_minutes' =&gt; 'sometimes|integer|min:5|max:480',<br>            'is_available' =&gt; 'sometimes|boolean',<br>        ]);</p><p>        $slot-&gt;update($validated);</p><p>        return response()-&gt;json(['slot' =&gt; $slot-&gt;fresh()]);<br>    }</p><p>    /**<br>     * DELETE /api/calendar-slots/{id}<br>     */<br>    public function destroy(string $id)<br>    {<br>        $slot = CalendarSlot::active()-&gt;findOrFail($id);<br>        $slot-&gt;update(['is_active' =&gt; false]);</p><p>        return response()-&gt;json(['message' =&gt; 'Slot deleted.']);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.7 MedStreamController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/MedStreamController.php`  <br><strong>Route Prefix:</strong> `/api/medstream`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\MedStreamPost;<br>use App\Models\MedStreamComment;<br>use App\Models\MedStreamLike;<br>use App\Models\MedStreamBookmark;<br>use App\Models\MedStreamReport;<br>use App\Models\MedStreamEngagementCounter;<br>use App\Notifications\PostCommentedNotification;<br>use App\Services\MediaOptimizer;<br>use Illuminate\Http\Request;</p><p>class MedStreamController extends Controller<br>{<br>    // ── Posts ──</p><p>    public function posts(Request $request)<br>    {<br>        $userId = $request-&gt;user()?-&gt;id;</p><p>        $posts = MedStreamPost::visible()<br>            -&gt;with(['author:id,fullname,avatar,role_id', 'clinic:id,fullname,avatar', 'engagementCounter'])<br>            -&gt;when($request-&gt;author_id, fn($q, $v) =&gt; $q-&gt;where('author_id', $v))<br>            -&gt;when($request-&gt;clinic_id, fn($q, $v) =&gt; $q-&gt;where('clinic_id', $v))<br>            -&gt;when($request-&gt;post_type, fn($q, $v) =&gt; $q-&gt;where('post_type', $v))<br>            -&gt;orderByDesc('created_at')<br>            -&gt;paginate($request-&gt;per_page ?? 20);</p><p>        if ($userId) {<br>            $postIds = $posts-&gt;pluck('id')-&gt;toArray();<br>            $likedPostIds = MedStreamLike::where('user_id', $userId)<br>                -&gt;where('is_active', true)<br>                -&gt;whereIn('post_id', $postIds)<br>                -&gt;pluck('post_id')<br>                -&gt;toArray();<br>            $bookmarkedPostIds = MedStreamBookmark::where('user_id', $userId)<br>                -&gt;where('is_active', true)<br>                -&gt;where('bookmarked_type', 'post')<br>                -&gt;whereIn('target_id', $postIds)<br>                -&gt;pluck('target_id')<br>                -&gt;toArray();</p><p>            $posts-&gt;getCollection()-&gt;transform(function ($post) use ($likedPostIds, $bookmarkedPostIds) {<br>                $post-&gt;is_liked = in_array($post-&gt;id, $likedPostIds);<br>                $post-&gt;is_bookmarked = in_array($post-&gt;id, $bookmarkedPostIds);<br>                return $post;<br>            });<br>        }</p><p>        return response()-&gt;json($posts);<br>    }</p><p>    public function showPost(string $id, Request $request)<br>    {<br>        $post = MedStreamPost::visible()<br>            -&gt;with(['author:id,fullname,avatar,role_id', 'clinic:id,fullname,avatar', 'engagementCounter', 'comments' =&gt; fn($q) =&gt; $q-&gt;active()-&gt;where('is_hidden', false)-&gt;with('author:id,fullname,avatar')-&gt;latest()-&gt;limit(20)])<br>            -&gt;findOrFail($id);</p><p>        $userId = $request-&gt;user()?-&gt;id;<br>        $post-&gt;is_liked = $userId<br>            ? MedStreamLike::where('user_id', $userId)-&gt;where('post_id', $id)-&gt;where('is_active', true)-&gt;exists()<br>            : false;<br>        $post-&gt;is_bookmarked = $userId<br>            ? MedStreamBookmark::where('user_id', $userId)-&gt;where('bookmarked_type', 'post')-&gt;where('target_id', $id)-&gt;where('is_active', true)-&gt;exists()<br>            : false;</p><p>        return response()-&gt;json(['post' =&gt; $post]);<br>    }</p><p>    public function storePost(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        if (!in_array($user-&gt;role_id, ['doctor', 'clinicOwner', 'superAdmin', 'saasAdmin'])) {<br>            return response()-&gt;json(['message' =&gt; 'Only doctors and clinic owners can create posts.'], 403);<br>        }</p><p>        $validated = $request-&gt;validate([<br>            'post_type'  =&gt; 'required|in:text,image,video,document,mixed',<br>            'content'    =&gt; 'sometimes|string',<br>            'media_url'  =&gt; 'sometimes|string|url',<br>            'clinic_id'  =&gt; 'sometimes|uuid|exists:clinics,id',<br>            'photos'     =&gt; 'sometimes|array',<br>            'photos.*'   =&gt; 'file|mimes:jpg,jpeg,png,gif,bmp,webp,svg,heic,heif|max:10240',<br>            'videos'     =&gt; 'sometimes|array',<br>            'videos.*'   =&gt; 'file|mimetypes:video/mp4,video/quicktime,video/webm,video/avi|max:102400',<br>            'papers'     =&gt; 'sometimes|array',<br>            'papers.*'   =&gt; 'file|mimes:pdf,doc,docx,xls,xlsx,ppt,pptx,csv|max:20480',<br>        ]);</p><p>        $mediaUrl = $validated['media_url'] ?? null;<br>        $uploadedFiles = [];</p><p>        if ($request-&gt;hasFile('photos')) {<br>            foreach ($request-&gt;file('photos') as $file) {<br>                $result = MediaOptimizer::processImage($file);<br>                $uploadedFiles[] = $result;<br>                if (!$mediaUrl) {<br>                    $mediaUrl = $result['medium'] ?? $result['original'];<br>                }<br>            }<br>        }</p><p>        if ($request-&gt;hasFile('videos')) {<br>            foreach ($request-&gt;file('videos') as $file) {<br>                $result = MediaOptimizer::processVideo($file);<br>                $uploadedFiles[] = $result;<br>                if (!$mediaUrl) {<br>                    $mediaUrl = $result['thumb'] ?? $result['original'];<br>                }<br>            }<br>        }</p><p>        if ($request-&gt;hasFile('papers')) {<br>            foreach ($request-&gt;file('papers') as $file) {<br>                $result = MediaOptimizer::processDocument($file);<br>                $uploadedFiles[] = $result;<br>                if (!$mediaUrl) {<br>                    $mediaUrl = $result['original'];<br>                }<br>            }<br>        }</p><p>        $postData = [<br>            'author_id' =&gt; $user-&gt;id,<br>            'clinic_id' =&gt; $validated['clinic_id'] ?? $user-&gt;clinic_id,<br>            'post_type' =&gt; $validated['post_type'],<br>            'content'   =&gt; $validated['content'] ?? null,<br>            'media_url' =&gt; $mediaUrl,<br>            'media'     =&gt; !empty($uploadedFiles) ? $uploadedFiles : null,<br>        ];</p><p>        try {<br>            $post = MedStreamPost::create($postData);<br>        } catch (\Illuminate\Database\QueryException $e) {<br>            if (str_contains($e-&gt;getMessage(), 'post_type_check') || str_contains($e-&gt;getMessage(), 'check constraint')) {<br>                try {<br>                    $driver = \DB::connection()-&gt;getDriverName();<br>                    if ($driver === 'pgsql') {<br>                        \DB::statement("ALTER TABLE med_stream_posts DROP CONSTRAINT IF EXISTS med_stream_posts_post_type_check");<br>                        \DB::statement("ALTER TABLE med_stream_posts ADD CONSTRAINT med_stream_posts_post_type_check CHECK (post_type::text = ANY (ARRAY['text','image','video','document','mixed']))");<br>                    }<br>                    $post = MedStreamPost::create($postData);<br>                } catch (\Throwable $retryErr) {<br>                    \Log::error('MedStream storePost retry failed', ['error' =&gt; $retryErr-&gt;getMessage()]);<br>                    return response()-&gt;json(['message' =&gt; 'Failed to create post. Please contact support.'], 500);<br>                }<br>            } else {<br>                throw $e;<br>            }<br>        }</p><p>        MedStreamEngagementCounter::create([<br>            'post_id'       =&gt; $post-&gt;id,<br>            'like_count'    =&gt; 0,<br>            'comment_count' =&gt; 0,<br>        ]);</p><p>        $post-&gt;load('author:id,fullname,avatar');</p><p>        return response()-&gt;json(['post' =&gt; $post], 201);<br>    }</p><p>    public function updatePost(Request $request, string $id)<br>    {<br>        $post = MedStreamPost::active()-&gt;findOrFail($id);</p><p>        if ($post-&gt;author_id !== $request-&gt;user()-&gt;id &amp;&amp; !$request-&gt;user()-&gt;isAdmin()) {<br>            return response()-&gt;json(['message' =&gt; 'Forbidden.'], 403);<br>        }</p><p>        $validated = $request-&gt;validate([<br>            'content' =&gt; 'sometimes|string',<br>            'media_url' =&gt; 'sometimes|string|url',<br>            'is_hidden' =&gt; 'sometimes|boolean',<br>        ]);</p><p>        $post-&gt;update($validated);</p><p>        return response()-&gt;json(['post' =&gt; $post-&gt;fresh()]);<br>    }</p><p>    public function destroyPost(string $id, Request $request)<br>    {<br>        $post = MedStreamPost::active()-&gt;findOrFail($id);</p><p>        if ($post-&gt;author_id !== $request-&gt;user()-&gt;id &amp;&amp; !$request-&gt;user()-&gt;isAdmin()) {<br>            return response()-&gt;json(['message' =&gt; 'Forbidden.'], 403);<br>        }</p><p>        $this-&gt;deletePostMedia($post);</p><p>        MedStreamComment::where('post_id', $id)-&gt;update(['is_active' =&gt; false]);<br>        MedStreamLike::where('post_id', $id)-&gt;update(['is_active' =&gt; false]);<br>        MedStreamReport::where('post_id', $id)-&gt;update(['is_active' =&gt; false]);<br>        MedStreamEngagementCounter::where('post_id', $id)-&gt;delete();</p><p>        $post-&gt;update(['is_active' =&gt; false, 'is_hidden' =&gt; true]);</p><p>        return response()-&gt;json(['message' =&gt; 'Post deleted.']);<br>    }</p><p>    private function deletePostMedia(MedStreamPost $post): void<br>    {<br>        try {<br>            $mediaItems = $post-&gt;media;<br>            if (!is_array($mediaItems) || empty($mediaItems)) return;</p><p>            foreach ($mediaItems as $item) {<br>                foreach (['original', 'medium', 'thumb'] as $variant) {<br>                    $url = $item[$variant] ?? null;<br>                    if (!$url || !is_string($url)) continue;</p><p>                    $storagePath = $this-&gt;urlToStoragePath($url);<br>                    if ($storagePath &amp;&amp; \Storage::disk('public')-&gt;exists($storagePath)) {<br>                        \Storage::disk('public')-&gt;delete($storagePath);<br>                    }<br>                }<br>            }<br>        } catch (\Throwable $e) {<br>            \Log::warning('Failed to delete post media files', ['post_id' =&gt; $post-&gt;id, 'error' =&gt; $e-&gt;getMessage()]);<br>        }<br>    }</p><p>    private function urlToStoragePath(string $url): ?string<br>    {<br>        $marker = '/storage/';<br>        $pos = strpos($url, $marker);<br>        if ($pos === false) return null;<br>        return substr($url, $pos + strlen($marker));<br>    }</p><p>    // ── Comments ──</p><p>    public function comments(Request $request, string $postId)<br>    {<br>        $comments = MedStreamComment::active()<br>            -&gt;where('post_id', $postId)<br>            -&gt;where('is_hidden', false)<br>            -&gt;whereNull('parent_id')<br>            -&gt;with(['author:id,fullname,avatar', 'replies' =&gt; fn($q) =&gt; $q-&gt;with('author:id,fullname,avatar')-&gt;orderBy('created_at')])<br>            -&gt;orderByDesc('created_at')<br>            -&gt;paginate($request-&gt;per_page ?? 20);</p><p>        return response()-&gt;json($comments);<br>    }</p><p>    public function storeComment(Request $request, string $postId)<br>    {<br>        $validated = $request-&gt;validate([<br>            'content' =&gt; 'required|string|max:2000',<br>            'parent_id' =&gt; 'sometimes|nullable|uuid|exists:med_stream_comments,id',<br>        ]);</p><p>        $post = MedStreamPost::with('author:id,fullname')-&gt;findOrFail($postId);</p><p>        $comment = MedStreamComment::create([<br>            'post_id' =&gt; $postId,<br>            'author_id' =&gt; $request-&gt;user()-&gt;id,<br>            'parent_id' =&gt; $validated['parent_id'] ?? null,<br>            'content' =&gt; $validated['content'],<br>        ]);</p><p>        MedStreamEngagementCounter::where('post_id', $postId)-&gt;increment('comment_count');</p><p>        try {<br>            if ($post-&gt;author &amp;&amp; $post-&gt;author_id !== $request-&gt;user()-&gt;id) {<br>                $post-&gt;author-&gt;notify(<br>                    new PostCommentedNotification(<br>                        $post,<br>                        $comment,<br>                        $request-&gt;user()-&gt;fullname ?? 'Someone'<br>                    )<br>                );<br>            }<br>        } catch (\Throwable $e) {<br>            \Log::warning('Post comment notification failed: ' . $e-&gt;getMessage());<br>        }</p><p>        return response()-&gt;json(['comment' =&gt; $comment-&gt;load('author:id,fullname,avatar')], 201);<br>    }</p><p>    // ── Likes ──</p><p>    public function toggleLike(Request $request, string $postId)<br>    {<br>        $userId = $request-&gt;user()-&gt;id;</p><p>        $existing = MedStreamLike::where('post_id', $postId)<br>            -&gt;where('user_id', $userId)<br>            -&gt;first();</p><p>        if ($existing) {<br>            if ($existing-&gt;is_active) {<br>                $existing-&gt;update(['is_active' =&gt; false]);<br>                MedStreamEngagementCounter::where('post_id', $postId)-&gt;where('like_count', '&gt;', 0)-&gt;decrement('like_count');<br>                return response()-&gt;json(['liked' =&gt; false]);<br>            } else {<br>                $existing-&gt;update(['is_active' =&gt; true]);<br>                MedStreamEngagementCounter::where('post_id', $postId)-&gt;increment('like_count');<br>                return response()-&gt;json(['liked' =&gt; true]);<br>            }<br>        }</p><p>        MedStreamLike::create(['post_id' =&gt; $postId, 'user_id' =&gt; $userId]);<br>        MedStreamEngagementCounter::where('post_id', $postId)-&gt;increment('like_count');</p><p>        return response()-&gt;json(['liked' =&gt; true], 201);<br>    }</p><p>    // ── Bookmarks ──</p><p>    public function bookmarks(Request $request)<br>    {<br>        $bookmarks = MedStreamBookmark::active()<br>            -&gt;where('user_id', $request-&gt;user()-&gt;id)<br>            -&gt;when($request-&gt;type, fn($q, $v) =&gt; $q-&gt;where('bookmarked_type', $v))<br>            -&gt;orderByDesc('created_at')<br>            -&gt;paginate($request-&gt;per_page ?? 20);</p><p>        return response()-&gt;json($bookmarks);<br>    }</p><p>    public function toggleBookmark(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'bookmarked_type' =&gt; 'required|in:post,doctor,clinic,patient',<br>            'target_id' =&gt; 'required|uuid',<br>        ]);</p><p>        $existing = MedStreamBookmark::where('user_id', $request-&gt;user()-&gt;id)<br>            -&gt;where('bookmarked_type', $validated['bookmarked_type'])<br>            -&gt;where('target_id', $validated['target_id'])<br>            -&gt;first();</p><p>        if ($existing) {<br>            $existing-&gt;update(['is_active' =&gt; !$existing-&gt;is_active]);<br>            return response()-&gt;json(['bookmarked' =&gt; $existing-&gt;fresh()-&gt;is_active]);<br>        }</p><p>        MedStreamBookmark::create([<br>            'user_id' =&gt; $request-&gt;user()-&gt;id,<br>            'bookmarked_type' =&gt; $validated['bookmarked_type'],<br>            'target_id' =&gt; $validated['target_id'],<br>        ]);</p><p>        return response()-&gt;json(['bookmarked' =&gt; true], 201);<br>    }</p><p>    // ── Reports ──</p><p>    public function storeReport(Request $request, string $postId)<br>    {<br>        $validated = $request-&gt;validate([<br>            'reason' =&gt; 'required|string|max:255',<br>        ]);</p><p>        $report = MedStreamReport::updateOrCreate(<br>            ['post_id' =&gt; $postId, 'reporter_id' =&gt; $request-&gt;user()-&gt;id],<br>            ['reason' =&gt; $validated['reason'], 'admin_status' =&gt; 'pending']<br>        );</p><p>        return response()-&gt;json(['report' =&gt; $report], 201);<br>    }</p><p>    public function reports(Request $request)<br>    {<br>        $reports = MedStreamReport::active()<br>            -&gt;with(['post:id,content,author_id', 'reporter:id,fullname'])<br>            -&gt;when($request-&gt;status, fn($q, $v) =&gt; $q-&gt;where('admin_status', $v))<br>            -&gt;orderByDesc('created_at')<br>            -&gt;paginate($request-&gt;per_page ?? 20);</p><p>        return response()-&gt;json($reports);<br>    }</p><p>    public function updateReport(Request $request, string $id)<br>    {<br>        $report = MedStreamReport::active()-&gt;findOrFail($id);</p><p>        $validated = $request-&gt;validate([<br>            'admin_status' =&gt; 'required|in:pending,reviewed,hidden,deleted',<br>        ]);</p><p>        $report-&gt;update($validated);</p><p>        if (in_array($validated['admin_status'], ['hidden', 'deleted'])) {<br>            MedStreamPost::where('id', $report-&gt;post_id)-&gt;update(['is_hidden' =&gt; true]);<br>        }</p><p>        return response()-&gt;json(['report' =&gt; $report-&gt;fresh()]);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.8 MessageController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/MessageController.php`  <br><strong>Route Prefix:</strong> `/api/messages`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\Conversation;<br>use App\Models\ConversationParticipant;<br>use App\Models\Message;<br>use App\Models\MessageAttachment;<br>use Illuminate\Http\Request;<br>use Illuminate\Support\Facades\Storage;<br>use Illuminate\Support\Str;</p><p>class MessageController extends Controller<br>{<br>    /**<br>     * GET /api/messages/conversations<br>     */<br>    public function conversations(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        $conversations = Conversation::active()<br>            -&gt;forUser($user-&gt;id)<br>            -&gt;with([<br>                'latestMessage:id,conversation_id,sender_id,body,type,created_at',<br>                'latestMessage.sender:id,fullname,avatar',<br>                'activeParticipants.user:id,fullname,avatar,role_id',<br>            ])<br>            -&gt;withCount([<br>                'messages as unread_count' =&gt; function ($q) use ($user) {<br>                    $q-&gt;where('sender_id', '!=', $user-&gt;id)<br>                      -&gt;where('is_active', true)<br>                      -&gt;whereDoesntHave('readReceipts', fn($rq) =&gt; $rq-&gt;where('user_id', $user-&gt;id));<br>                },<br>            ])<br>            -&gt;orderByDesc(<br>                Message::select('created_at')<br>                    -&gt;whereColumn('conversation_id', 'conversations.id')<br>                    -&gt;where('is_active', true)<br>                    -&gt;orderByDesc('created_at')<br>                    -&gt;limit(1)<br>            )<br>            -&gt;paginate($request-&gt;per_page ?? 20);</p><p>        $conversations-&gt;getCollection()-&gt;transform(function ($conv) use ($user) {<br>            $participant = $conv-&gt;activeParticipants<br>                -&gt;where('user_id', $user-&gt;id)<br>                -&gt;first();</p><p>            return [<br>                'id' =&gt; $conv-&gt;id,<br>                'type' =&gt; $conv-&gt;type,<br>                'title' =&gt; $conv-&gt;title,<br>                'clinic_id' =&gt; $conv-&gt;clinic_id,<br>                'is_muted' =&gt; $participant?-&gt;is_muted ?? false,<br>                'is_archived' =&gt; $participant?-&gt;is_archived ?? false,<br>                'unread_count' =&gt; $conv-&gt;unread_count,<br>                'participants' =&gt; $conv-&gt;activeParticipants-&gt;map(fn($p) =&gt; [<br>                    'id' =&gt; $p-&gt;user-&gt;id,<br>                    'fullname' =&gt; $p-&gt;user-&gt;fullname,<br>                    'avatar' =&gt; $p-&gt;user-&gt;avatar,<br>                    'role_id' =&gt; $p-&gt;user-&gt;role_id,<br>                    'role' =&gt; $p-&gt;role,<br>                ]),<br>                'latest_message' =&gt; $conv-&gt;latestMessage ? [<br>                    'id' =&gt; $conv-&gt;latestMessage-&gt;id,<br>                    'body' =&gt; $conv-&gt;latestMessage-&gt;body,<br>                    'type' =&gt; $conv-&gt;latestMessage-&gt;type,<br>                    'sender_id' =&gt; $conv-&gt;latestMessage-&gt;sender_id,<br>                    'sender_name' =&gt; $conv-&gt;latestMessage-&gt;sender?-&gt;fullname,<br>                    'created_at' =&gt; $conv-&gt;latestMessage-&gt;created_at,<br>                ] : null,<br>                'created_at' =&gt; $conv-&gt;created_at,<br>                'updated_at' =&gt; $conv-&gt;updated_at,<br>            ];<br>        });</p><p>        return response()-&gt;json($conversations);<br>    }</p><p>    /**<br>     * POST /api/messages/conversations<br>     */<br>    public function createConversation(Request $request)<br>    {<br>        $request-&gt;validate([<br>            'participant_ids' =&gt; 'required|array|min:1',<br>            'participant_ids.*' =&gt; 'uuid|exists:users,id',<br>            'type' =&gt; 'in:direct,group',<br>            'title' =&gt; 'nullable|string|max:255',<br>        ]);</p><p>        $user = $request-&gt;user();<br>        $participantIds = $request-&gt;participant_ids;<br>        $type = $request-&gt;type ?? (count($participantIds) === 1 ? 'direct' : 'group');</p><p>        if ($type === 'direct' &amp;&amp; count($participantIds) === 1) {<br>            $conversation = Conversation::findOrCreateDirect(<br>                $user-&gt;id,<br>                $participantIds[0],<br>                $user-&gt;clinic_id<br>            );</p><p>            return response()-&gt;json([<br>                'conversation' =&gt; $this-&gt;formatConversation($conversation, $user-&gt;id),<br>                'created' =&gt; $conversation-&gt;wasRecentlyCreated,<br>            ], $conversation-&gt;wasRecentlyCreated ? 201 : 200);<br>        }</p><p>        $conversation = Conversation::create([<br>            'type' =&gt; 'group',<br>            'title' =&gt; $request-&gt;title,<br>            'clinic_id' =&gt; $user-&gt;clinic_id,<br>        ]);</p><p>        $conversation-&gt;participants()-&gt;create([<br>            'user_id' =&gt; $user-&gt;id,<br>            'role' =&gt; 'admin',<br>        ]);</p><p>        foreach ($participantIds as $pid) {<br>            if ($pid !== $user-&gt;id) {<br>                $conversation-&gt;participants()-&gt;create([<br>                    'user_id' =&gt; $pid,<br>                    'role' =&gt; 'member',<br>                ]);<br>            }<br>        }</p><p>        $conversation-&gt;load(['activeParticipants.user:id,fullname,avatar,role_id']);</p><p>        return response()-&gt;json([<br>            'conversation' =&gt; $this-&gt;formatConversation($conversation, $user-&gt;id),<br>        ], 201);<br>    }</p><p>    public function showConversation(Request $request, string $id)<br>    {<br>        $user = $request-&gt;user();</p><p>        $conversation = Conversation::active()<br>            -&gt;forUser($user-&gt;id)<br>            -&gt;with(['activeParticipants.user:id,fullname,avatar,role_id'])<br>            -&gt;findOrFail($id);</p><p>        return response()-&gt;json([<br>            'conversation' =&gt; $this-&gt;formatConversation($conversation, $user-&gt;id),<br>        ]);<br>    }</p><p>    public function updateConversation(Request $request, string $id)<br>    {<br>        $user = $request-&gt;user();</p><p>        $conversation = Conversation::active()<br>            -&gt;forUser($user-&gt;id)<br>            -&gt;findOrFail($id);</p><p>        $participant = $conversation-&gt;participants()<br>            -&gt;where('user_id', $user-&gt;id)<br>            -&gt;firstOrFail();</p><p>        if ($request-&gt;has('title') &amp;&amp; $conversation-&gt;type === 'group' &amp;&amp; $participant-&gt;role === 'admin') {<br>            $conversation-&gt;update(['title' =&gt; $request-&gt;title]);<br>        }</p><p>        if ($request-&gt;has('is_muted')) {<br>            $participant-&gt;update(['is_muted' =&gt; (bool) $request-&gt;is_muted]);<br>        }<br>        if ($request-&gt;has('is_archived')) {<br>            $participant-&gt;update(['is_archived' =&gt; (bool) $request-&gt;is_archived]);<br>        }</p><p>        return response()-&gt;json(['message' =&gt; 'Updated', 'conversation' =&gt; $this-&gt;formatConversation($conversation-&gt;fresh(), $user-&gt;id)]);<br>    }</p><p>    public function deleteConversation(Request $request, string $id)<br>    {<br>        $user = $request-&gt;user();</p><p>        $conversation = Conversation::active()<br>            -&gt;forUser($user-&gt;id)<br>            -&gt;findOrFail($id);</p><p>        $conversation-&gt;participants()<br>            -&gt;where('user_id', $user-&gt;id)<br>            -&gt;update(['is_active' =&gt; false]);</p><p>        if ($conversation-&gt;activeParticipants()-&gt;count() === 0) {<br>            $conversation-&gt;update(['is_active' =&gt; false]);<br>        }</p><p>        return response()-&gt;json(['message' =&gt; 'Conversation left']);<br>    }</p><p>    /**<br>     * GET /api/messages/conversations/{conversationId}/messages<br>     */<br>    public function messages(Request $request, string $conversationId)<br>    {<br>        $user = $request-&gt;user();</p><p>        $conversation = Conversation::active()<br>            -&gt;forUser($user-&gt;id)<br>            -&gt;findOrFail($conversationId);</p><p>        $messages = $conversation-&gt;messages()<br>            -&gt;active()<br>            -&gt;with([<br>                'sender:id,fullname,avatar,role_id',<br>                'attachments',<br>                'replyTo:id,sender_id,body',<br>                'replyTo.sender:id,fullname',<br>            ])<br>            -&gt;orderByDesc('created_at')<br>            -&gt;paginate($request-&gt;per_page ?? 50);</p><p>        $conversation-&gt;participants()<br>            -&gt;where('user_id', $user-&gt;id)<br>            -&gt;update(['last_read_at' =&gt; now()]);</p><p>        $messages-&gt;getCollection()-&gt;transform(fn($msg) =&gt; $this-&gt;formatMessage($msg, $user-&gt;id));</p><p>        return response()-&gt;json($messages);<br>    }</p><p>    /**<br>     * POST /api/messages/conversations/{conversationId}/messages<br>     */<br>    public function sendMessage(Request $request, string $conversationId)<br>    {<br>        $request-&gt;validate([<br>            'body' =&gt; 'nullable|string|max:5000',<br>            'type' =&gt; 'in:text,image,file,video,audio',<br>            'reply_to_id' =&gt; 'nullable|uuid|exists:messages,id',<br>            'attachments' =&gt; 'nullable|array|max:10',<br>            'attachments.*' =&gt; 'file|max:51200',<br>        ]);</p><p>        $user = $request-&gt;user();</p><p>        $conversation = Conversation::active()<br>            -&gt;forUser($user-&gt;id)<br>            -&gt;findOrFail($conversationId);</p><p>        $hasAttachments = $request-&gt;hasFile('attachments');<br>        $body = $request-&gt;body;</p><p>        if (!$body &amp;&amp; !$hasAttachments) {<br>            return response()-&gt;json(['message' =&gt; 'Message body or attachments required'], 422);<br>        }</p><p>        $type = $request-&gt;type ?? 'text';<br>        if ($hasAttachments &amp;&amp; $type === 'text') {<br>            $firstFile = $request-&gt;file('attachments')[0];<br>            $mime = $firstFile-&gt;getMimeType();<br>            if (str_starts_with($mime, 'image/')) $type = 'image';<br>            elseif (str_starts_with($mime, 'video/')) $type = 'video';<br>            elseif (str_starts_with($mime, 'audio/')) $type = 'audio';<br>            else $type = 'file';<br>        }</p><p>        $message = Message::create([<br>            'conversation_id' =&gt; $conversation-&gt;id,<br>            'sender_id' =&gt; $user-&gt;id,<br>            'reply_to_id' =&gt; $request-&gt;reply_to_id,<br>            'body' =&gt; $body,<br>            'type' =&gt; $type,<br>        ]);</p><p>        if ($hasAttachments) {<br>            foreach ($request-&gt;file('attachments') as $file) {<br>                $originalName = $file-&gt;getClientOriginalName();<br>                $mime = $file-&gt;getMimeType();<br>                $isImage = str_starts_with($mime, 'image/') &amp;&amp; !str_contains($mime, 'svg');<br>                $dir = 'messages/' . $conversation-&gt;id;<br>                $thumbPath = null;</p><p>                if ($isImage) {<br>                    $path = $this-&gt;optimizeAndStoreImage($file, $dir);<br>                    $thumbPath = $this-&gt;createThumbnail($file, $dir);<br>                } else {<br>                    $path = $file-&gt;store($dir, 'public');<br>                }</p><p>                MessageAttachment::create([<br>                    'message_id' =&gt; $message-&gt;id,<br>                    'file_name' =&gt; $originalName,<br>                    'file_path' =&gt; $path,<br>                    'file_type' =&gt; $mime,<br>                    'file_size' =&gt; Storage::disk('public')-&gt;size($path),<br>                    'thumb_path' =&gt; $thumbPath,<br>                ]);<br>            }<br>        }</p><p>        $conversation-&gt;participants()<br>            -&gt;where('user_id', $user-&gt;id)<br>            -&gt;update(['last_read_at' =&gt; now()]);</p><p>        $message-&gt;load([<br>            'sender:id,fullname,avatar,role_id',<br>            'attachments',<br>            'replyTo:id,sender_id,body',<br>            'replyTo.sender:id,fullname',<br>        ]);</p><p>        return response()-&gt;json([<br>            'message' =&gt; $this-&gt;formatMessage($message, $user-&gt;id),<br>        ], 201);<br>    }</p><p>    public function updateMessage(Request $request, string $messageId)<br>    {<br>        $request-&gt;validate([<br>            'body' =&gt; 'required|string|max:5000',<br>        ]);</p><p>        $user = $request-&gt;user();<br>        $message = Message::active()-&gt;where('sender_id', $user-&gt;id)-&gt;findOrFail($messageId);</p><p>        $message-&gt;update([<br>            'body' =&gt; $request-&gt;body,<br>            'is_edited' =&gt; true,<br>            'edited_at' =&gt; now(),<br>        ]);</p><p>        return response()-&gt;json([<br>            'message' =&gt; $this-&gt;formatMessage($message-&gt;fresh(['sender:id,fullname,avatar,role_id', 'attachments']), $user-&gt;id),<br>        ]);<br>    }</p><p>    public function deleteMessage(Request $request, string $messageId)<br>    {<br>        $user = $request-&gt;user();<br>        $message = Message::active()-&gt;where('sender_id', $user-&gt;id)-&gt;findOrFail($messageId);</p><p>        $message-&gt;update(['is_active' =&gt; false]);<br>        $message-&gt;delete();</p><p>        return response()-&gt;json(['message' =&gt; 'Message deleted']);<br>    }</p><p>    /**<br>     * POST /api/messages/conversations/{conversationId}/read<br>     */<br>    public function markRead(Request $request, string $conversationId)<br>    {<br>        $user = $request-&gt;user();</p><p>        $conversation = Conversation::active()<br>            -&gt;forUser($user-&gt;id)<br>            -&gt;findOrFail($conversationId);</p><p>        $conversation-&gt;participants()<br>            -&gt;where('user_id', $user-&gt;id)<br>            -&gt;update(['last_read_at' =&gt; now()]);</p><p>        return response()-&gt;json(['message' =&gt; 'Marked as read']);<br>    }</p><p>    /**<br>     * GET /api/messages/search<br>     */<br>    public function search(Request $request)<br>    {<br>        $request-&gt;validate([<br>            'q' =&gt; 'required|string|min:2|max:200',<br>        ]);</p><p>        $user = $request-&gt;user();<br>        $query = $request-&gt;q;</p><p>        $conversationIds = ConversationParticipant::where('user_id', $user-&gt;id)<br>            -&gt;where('is_active', true)<br>            -&gt;pluck('conversation_id');</p><p>        $messages = Message::active()<br>            -&gt;whereIn('conversation_id', $conversationIds)<br>            -&gt;where('body', 'ilike', "%{$query}%")<br>            -&gt;with([<br>                'sender:id,fullname,avatar',<br>                'conversation:id,type,title',<br>            ])<br>            -&gt;orderByDesc('created_at')<br>            -&gt;limit(50)<br>            -&gt;get()<br>            -&gt;map(fn($msg) =&gt; [<br>                'id' =&gt; $msg-&gt;id,<br>                'conversation_id' =&gt; $msg-&gt;conversation_id,<br>                'conversation_title' =&gt; $msg-&gt;conversation-&gt;title,<br>                'conversation_type' =&gt; $msg-&gt;conversation-&gt;type,<br>                'body' =&gt; $msg-&gt;body,<br>                'sender_name' =&gt; $msg-&gt;sender?-&gt;fullname,<br>                'sender_avatar' =&gt; $msg-&gt;sender?-&gt;avatar,<br>                'created_at' =&gt; $msg-&gt;created_at,<br>            ]);</p><p>        return response()-&gt;json(['results' =&gt; $messages]);<br>    }</p><p>    /**<br>     * GET /api/messages/unread-count<br>     */<br>    public function unreadCount(Request $request)<br>    {<br>        $user = $request-&gt;user();</p><p>        $participations = ConversationParticipant::where('user_id', $user-&gt;id)<br>            -&gt;where('is_active', true)<br>            -&gt;get();</p><p>        $total = 0;<br>        foreach ($participations as $p) {<br>            $query = Message::where('conversation_id', $p-&gt;conversation_id)<br>                -&gt;where('sender_id', '!=', $user-&gt;id)<br>                -&gt;where('is_active', true);</p><p>            if ($p-&gt;last_read_at) {<br>                $query-&gt;where('created_at', '&gt;', $p-&gt;last_read_at);<br>            }<br>            $total += $query-&gt;count();<br>        }</p><p>        return response()-&gt;json(['unread_count' =&gt; $total]);<br>    }</p><p>    // ── Helpers ──</p><p>    private function formatConversation(Conversation $conv, string $userId): array<br>    {<br>        $participant = $conv-&gt;participants-&gt;where('user_id', $userId)-&gt;first()<br>            ?? $conv-&gt;activeParticipants-&gt;where('user_id', $userId)-&gt;first();</p><p>        return [<br>            'id' =&gt; $conv-&gt;id,<br>            'type' =&gt; $conv-&gt;type,<br>            'title' =&gt; $conv-&gt;title,<br>            'clinic_id' =&gt; $conv-&gt;clinic_id,<br>            'is_muted' =&gt; $participant?-&gt;is_muted ?? false,<br>            'is_archived' =&gt; $participant?-&gt;is_archived ?? false,<br>            'participants' =&gt; ($conv-&gt;activeParticipants ?? $conv-&gt;participants)-&gt;map(fn($p) =&gt; [<br>                'id' =&gt; $p-&gt;user-&gt;id ?? $p-&gt;user_id,<br>                'fullname' =&gt; $p-&gt;user-&gt;fullname ?? null,<br>                'avatar' =&gt; $p-&gt;user-&gt;avatar ?? null,<br>                'role_id' =&gt; $p-&gt;user-&gt;role_id ?? null,<br>                'role' =&gt; $p-&gt;role,<br>            ]),<br>            'created_at' =&gt; $conv-&gt;created_at,<br>            'updated_at' =&gt; $conv-&gt;updated_at,<br>        ];<br>    }</p><p>    private function optimizeAndStoreImage($file, string $dir): string<br>    {<br>        $maxWidth = 1920;<br>        $maxHeight = 1920;<br>        $quality = 82;</p><p>        $image = @imagecreatefromstring(file_get_contents($file-&gt;getRealPath()));<br>        if (!$image) {<br>            return $file-&gt;store($dir, 'public');<br>        }</p><p>        $origW = imagesx($image);<br>        $origH = imagesy($image);</p><p>        if ($origW &gt; $maxWidth || $origH &gt; $maxHeight) {<br>            $ratio = min($maxWidth / $origW, $maxHeight / $origH);<br>            $newW = (int) round($origW * $ratio);<br>            $newH = (int) round($origH * $ratio);<br>            $resized = imagecreatetruecolor($newW, $newH);<br>            imagealphablending($resized, false);<br>            imagesavealpha($resized, true);<br>            imagecopyresampled($resized, $image, 0, 0, 0, 0, $newW, $newH, $origW, $origH);<br>            imagedestroy($image);<br>            $image = $resized;<br>        }</p><p>        $filename = Str::uuid() . '.webp';<br>        $storagePath = $dir . '/' . $filename;<br>        $fullPath = Storage::disk('public')-&gt;path($storagePath);</p><p>        $dirPath = dirname($fullPath);<br>        if (!is_dir($dirPath)) {<br>            mkdir($dirPath, 0755, true);<br>        }</p><p>        imagewebp($image, $fullPath, $quality);<br>        imagedestroy($image);</p><p>        return $storagePath;<br>    }</p><p>    private function createThumbnail($file, string $dir): ?string<br>    {<br>        $thumbSize = 200;</p><p>        $image = @imagecreatefromstring(file_get_contents($file-&gt;getRealPath()));<br>        if (!$image) return null;</p><p>        $origW = imagesx($image);<br>        $origH = imagesy($image);<br>        $ratio = min($thumbSize / $origW, $thumbSize / $origH);<br>        $newW = max(1, (int) round($origW * $ratio));<br>        $newH = max(1, (int) round($origH * $ratio));</p><p>        $thumb = imagecreatetruecolor($newW, $newH);<br>        imagealphablending($thumb, false);<br>        imagesavealpha($thumb, true);<br>        imagecopyresampled($thumb, $image, 0, 0, 0, 0, $newW, $newH, $origW, $origH);<br>        imagedestroy($image);</p><p>        $filename = Str::uuid() . '_thumb.webp';<br>        $storagePath = $dir . '/' . $filename;<br>        $fullPath = Storage::disk('public')-&gt;path($storagePath);</p><p>        $dirPath = dirname($fullPath);<br>        if (!is_dir($dirPath)) {<br>            mkdir($dirPath, 0755, true);<br>        }</p><p>        imagewebp($thumb, $fullPath, 60);<br>        imagedestroy($thumb);</p><p>        return $storagePath;<br>    }</p><p>    private function formatMessage(Message $msg, string $userId): array<br>    {<br>        return [<br>            'id' =&gt; $msg-&gt;id,<br>            'conversation_id' =&gt; $msg-&gt;conversation_id,<br>            'sender_id' =&gt; $msg-&gt;sender_id,<br>            'sender' =&gt; $msg-&gt;sender ? [<br>                'id' =&gt; $msg-&gt;sender-&gt;id,<br>                'fullname' =&gt; $msg-&gt;sender-&gt;fullname,<br>                'avatar' =&gt; $msg-&gt;sender-&gt;avatar,<br>                'role_id' =&gt; $msg-&gt;sender-&gt;role_id,<br>            ] : null,<br>            'body' =&gt; $msg-&gt;body,<br>            'type' =&gt; $msg-&gt;type,<br>            'is_own' =&gt; $msg-&gt;sender_id === $userId,<br>            'is_edited' =&gt; $msg-&gt;is_edited,<br>            'edited_at' =&gt; $msg-&gt;edited_at,<br>            'reply_to' =&gt; $msg-&gt;replyTo ? [<br>                'id' =&gt; $msg-&gt;replyTo-&gt;id,<br>                'body' =&gt; $msg-&gt;replyTo-&gt;body,<br>                'sender_name' =&gt; $msg-&gt;replyTo-&gt;sender?-&gt;fullname,<br>            ] : null,<br>            'attachments' =&gt; $msg-&gt;attachments?-&gt;map(fn($a) =&gt; [<br>                'id' =&gt; $a-&gt;id,<br>                'file_name' =&gt; $a-&gt;file_name,<br>                'file_type' =&gt; $a-&gt;file_type,<br>                'file_size' =&gt; $a-&gt;file_size,<br>                'url' =&gt; $a-&gt;url,<br>                'thumb_url' =&gt; $a-&gt;thumb_url,<br>            ]) ?? [],<br>            'created_at' =&gt; $msg-&gt;created_at,<br>        ];<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.9 NotificationController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/NotificationController.php`  <br><strong>Route Prefix:</strong> `/api/notifications`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use Illuminate\Http\Request;</p><p>class NotificationController extends Controller<br>{<br>    /**<br>     * GET /api/notifications<br>     */<br>    public function index(Request $request)<br>    {<br>        $user = $request-&gt;user();<br>        $query = $user-&gt;notifications();</p><p>        if ($request-&gt;boolean('unread')) {<br>            $query = $user-&gt;unreadNotifications();<br>        }</p><p>        if ($request-&gt;filled('type')) {<br>            $query-&gt;whereJsonContains('data-&gt;type', $request-&gt;type);<br>        }</p><p>        $notifications = $query-&gt;orderBy('created_at', 'desc')<br>            -&gt;paginate($request-&gt;per_page ?? 20);</p><p>        return response()-&gt;json($notifications);<br>    }</p><p>    /**<br>     * GET /api/notifications/unread-count<br>     */<br>    public function unreadCount(Request $request)<br>    {<br>        $count = $request-&gt;user()-&gt;unreadNotifications()-&gt;count();<br>        return response()-&gt;json(['unread_count' =&gt; $count]);<br>    }</p><p>    /**<br>     * PUT /api/notifications/{id}/read<br>     */<br>    public function markAsRead(Request $request, string $id)<br>    {<br>        $notification = $request-&gt;user()<br>            -&gt;notifications()<br>            -&gt;findOrFail($id);</p><p>        $notification-&gt;markAsRead();</p><p>        return response()-&gt;json(['message' =&gt; 'Notification marked as read.']);<br>    }</p><p>    /**<br>     * PUT /api/notifications/read-all<br>     */<br>    public function markAllAsRead(Request $request)<br>    {<br>        $request-&gt;user()-&gt;unreadNotifications-&gt;markAsRead();<br>        return response()-&gt;json(['message' =&gt; 'All notifications marked as read.']);<br>    }</p><p>    /**<br>     * DELETE /api/notifications/{id}<br>     */<br>    public function destroy(Request $request, string $id)<br>    {<br>        $notification = $request-&gt;user()<br>            -&gt;notifications()<br>            -&gt;findOrFail($id);</p><p>        $notification-&gt;delete();</p><p>        return response()-&gt;json(['message' =&gt; 'Notification deleted.']);<br>    }</p><p>    /**<br>     * DELETE /api/notifications<br>     */<br>    public function destroyAll(Request $request)<br>    {<br>        $request-&gt;user()<br>            -&gt;notifications()<br>            -&gt;whereNotNull('read_at')<br>            -&gt;delete();</p><p>        return response()-&gt;json(['message' =&gt; 'Read notifications cleared.']);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.10 CatalogController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/CatalogController.php`  <br><strong>Route Prefix:</strong> `/api/catalog`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\Specialty;<br>use App\Models\City;<br>use App\Models\DiseaseCondition;<br>use App\Models\SymptomSpecialtyMapping;<br>use Illuminate\Http\Request;</p><p>class CatalogController extends Controller<br>{<br>    public function specialties(Request $request)<br>    {<br>        $specialties = Specialty::active()<br>            -&gt;ordered()<br>            -&gt;when($request-&gt;code, fn($q, $v) =&gt; $q-&gt;where('code', $v))<br>            -&gt;get();</p><p>        return response()-&gt;json(['specialties' =&gt; $specialties]);<br>    }</p><p>    public function storeSpecialty(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'code' =&gt; 'required|string|max:20|unique:specialties,code',<br>            'display_order' =&gt; 'sometimes|integer',<br>            'translations' =&gt; 'required|array',<br>        ]);</p><p>        $specialty = Specialty::create($validated);<br>        return response()-&gt;json(['specialty' =&gt; $specialty], 201);<br>    }</p><p>    public function updateSpecialty(Request $request, string $id)<br>    {<br>        $specialty = Specialty::active()-&gt;findOrFail($id);</p><p>        $validated = $request-&gt;validate([<br>            'display_order' =&gt; 'sometimes|integer',<br>            'translations' =&gt; 'sometimes|array',<br>        ]);</p><p>        $specialty-&gt;update($validated);<br>        return response()-&gt;json(['specialty' =&gt; $specialty-&gt;fresh()]);<br>    }</p><p>    public function destroySpecialty(string $id)<br>    {<br>        Specialty::active()-&gt;findOrFail($id)-&gt;update(['is_active' =&gt; false]);<br>        return response()-&gt;json(['message' =&gt; 'Specialty deleted.']);<br>    }</p><p>    public function cities(Request $request)<br>    {<br>        $cities = City::active()<br>            -&gt;when($request-&gt;country_id, fn($q, $v) =&gt; $q-&gt;byCountry($v))<br>            -&gt;when($request-&gt;code, fn($q, $v) =&gt; $q-&gt;where('code', $v))<br>            -&gt;get();</p><p>        return response()-&gt;json(['cities' =&gt; $cities]);<br>    }</p><p>    public function storeCity(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'code' =&gt; 'required|string|max:20',<br>            'country_id' =&gt; 'required|integer',<br>            'translations' =&gt; 'required|array',<br>        ]);</p><p>        $city = City::create($validated);<br>        return response()-&gt;json(['city' =&gt; $city], 201);<br>    }</p><p>    public function updateCity(Request $request, string $id)<br>    {<br>        $city = City::active()-&gt;findOrFail($id);</p><p>        $validated = $request-&gt;validate([<br>            'translations' =&gt; 'sometimes|array',<br>        ]);</p><p>        $city-&gt;update($validated);<br>        return response()-&gt;json(['city' =&gt; $city-&gt;fresh()]);<br>    }</p><p>    public function destroyCity(string $id)<br>    {<br>        City::active()-&gt;findOrFail($id)-&gt;update(['is_active' =&gt; false]);<br>        return response()-&gt;json(['message' =&gt; 'City deleted.']);<br>    }</p><p>    public function diseases(Request $request)<br>    {<br>        $diseases = DiseaseCondition::active()<br>            -&gt;when($request-&gt;code, fn($q, $v) =&gt; $q-&gt;where('code', $v))<br>            -&gt;get();</p><p>        return response()-&gt;json(['diseases' =&gt; $diseases]);<br>    }</p><p>    public function storeDisease(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'code' =&gt; 'required|string|max:20|unique:disease_conditions,code',<br>            'recommended_specialty_ids' =&gt; 'sometimes|array',<br>            'translations' =&gt; 'required|array',<br>        ]);</p><p>        $disease = DiseaseCondition::create($validated);<br>        return response()-&gt;json(['disease' =&gt; $disease], 201);<br>    }</p><p>    public function updateDisease(Request $request, string $id)<br>    {<br>        $disease = DiseaseCondition::active()-&gt;findOrFail($id);</p><p>        $validated = $request-&gt;validate([<br>            'recommended_specialty_ids' =&gt; 'sometimes|array',<br>            'translations' =&gt; 'sometimes|array',<br>        ]);</p><p>        $disease-&gt;update($validated);<br>        return response()-&gt;json(['disease' =&gt; $disease-&gt;fresh()]);<br>    }</p><p>    public function symptoms(Request $request)<br>    {<br>        $symptoms = SymptomSpecialtyMapping::active()<br>            -&gt;when($request-&gt;symptom, fn($q, $v) =&gt; $q-&gt;where('symptom', 'like', "%{$v}%"))<br>            -&gt;get();</p><p>        return response()-&gt;json(['symptoms' =&gt; $symptoms]);<br>    }</p><p>    public function storeSymptom(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'symptom' =&gt; 'required|string|max:100|unique:symptom_specialty_mappings,symptom',<br>            'specialty_ids' =&gt; 'required|array',<br>            'translations' =&gt; 'required|array',<br>        ]);</p><p>        $mapping = SymptomSpecialtyMapping::create($validated);<br>        return response()-&gt;json(['symptom' =&gt; $mapping], 201);<br>    }</p><p>    public function updateSymptom(Request $request, string $id)<br>    {<br>        $mapping = SymptomSpecialtyMapping::active()-&gt;findOrFail($id);</p><p>        $validated = $request-&gt;validate([<br>            'specialty_ids' =&gt; 'sometimes|array',<br>            'translations' =&gt; 'sometimes|array',<br>        ]);</p><p>        $mapping-&gt;update($validated);<br>        return response()-&gt;json(['symptom' =&gt; $mapping-&gt;fresh()]);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.11 CrmController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/CrmController.php`  <br><strong>Route Prefix:</strong> `/api/crm`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\CrmTag;<br>use App\Models\CrmProcessStage;<br>use App\Models\ArchivedClinicRecord;<br>use Illuminate\Http\Request;</p><p>class CrmController extends Controller<br>{<br>    public function tags(Request $request)<br>    {<br>        $user = $request-&gt;user();<br>        $query = CrmTag::active();</p><p>        if ($user-&gt;isDoctor()) {<br>            $query-&gt;where('doctor_id', $user-&gt;id);<br>        } elseif ($user-&gt;isClinicOwner()) {<br>            $query-&gt;where('clinic_id', $user-&gt;clinic_id);<br>        }</p><p>        $query-&gt;when($request-&gt;patient_id, fn($q, $v) =&gt; $q-&gt;where('patient_id', $v));</p><p>        return response()-&gt;json($query-&gt;orderByDesc('created_at')-&gt;paginate($request-&gt;per_page ?? 50));<br>    }</p><p>    public function storeTag(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'patient_id' =&gt; 'required|uuid|exists:users,id',<br>            'tag' =&gt; 'required|string|max:100',<br>        ]);</p><p>        $tag = CrmTag::create([<br>            'doctor_id' =&gt; $request-&gt;user()-&gt;id,<br>            'patient_id' =&gt; $validated['patient_id'],<br>            'clinic_id' =&gt; $request-&gt;user()-&gt;clinic_id,<br>            'tag' =&gt; $validated['tag'],<br>            'created_by' =&gt; $request-&gt;user()-&gt;id,<br>        ]);</p><p>        return response()-&gt;json(['tag' =&gt; $tag], 201);<br>    }</p><p>    public function destroyTag(string $id)<br>    {<br>        CrmTag::active()-&gt;findOrFail($id)-&gt;update(['is_active' =&gt; false]);<br>        return response()-&gt;json(['message' =&gt; 'Tag deleted.']);<br>    }</p><p>    public function stages(Request $request)<br>    {<br>        $user = $request-&gt;user();<br>        $query = CrmProcessStage::active();</p><p>        if ($user-&gt;isDoctor()) {<br>            $query-&gt;where('doctor_id', $user-&gt;id);<br>        } elseif ($user-&gt;isClinicOwner()) {<br>            $query-&gt;where('clinic_id', $user-&gt;clinic_id);<br>        }</p><p>        $query-&gt;when($request-&gt;patient_id, fn($q, $v) =&gt; $q-&gt;where('patient_id', $v));</p><p>        return response()-&gt;json($query-&gt;orderByDesc('created_at')-&gt;paginate($request-&gt;per_page ?? 50));<br>    }</p><p>    public function storeStage(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'patient_id' =&gt; 'required|uuid|exists:users,id',<br>            'stage' =&gt; 'required|string|max:100',<br>        ]);</p><p>        $stage = CrmProcessStage::create([<br>            'doctor_id' =&gt; $request-&gt;user()-&gt;id,<br>            'patient_id' =&gt; $validated['patient_id'],<br>            'clinic_id' =&gt; $request-&gt;user()-&gt;clinic_id,<br>            'stage' =&gt; $validated['stage'],<br>            'started_at' =&gt; now()-&gt;toDateString(),<br>            'updated_by' =&gt; $request-&gt;user()-&gt;id,<br>        ]);</p><p>        return response()-&gt;json(['stage' =&gt; $stage], 201);<br>    }</p><p>    public function updateStage(Request $request, string $id)<br>    {<br>        $stage = CrmProcessStage::active()-&gt;findOrFail($id);</p><p>        $validated = $request-&gt;validate([<br>            'stage' =&gt; 'required|string|max:100',<br>        ]);</p><p>        $stage-&gt;update([<br>            'stage' =&gt; $validated['stage'],<br>            'updated_by' =&gt; $request-&gt;user()-&gt;id,<br>        ]);</p><p>        return response()-&gt;json(['stage' =&gt; $stage-&gt;fresh()]);<br>    }</p><p>    public function archivedRecords(Request $request)<br>    {<br>        $user = $request-&gt;user();<br>        $query = ArchivedClinicRecord::active()-&gt;with(['formerDoctor:id,fullname', 'archivedPatient:id,fullname']);</p><p>        if ($user-&gt;isClinicOwner()) {<br>            $query-&gt;where('clinic_id', $user-&gt;clinic_id);<br>        }</p><p>        return response()-&gt;json($query-&gt;orderByDesc('archived_at')-&gt;paginate($request-&gt;per_page ?? 20));<br>    }</p><p>    public function storeArchivedRecord(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'former_doctor_id' =&gt; 'required|uuid|exists:users,id',<br>            'archived_patient_id' =&gt; 'required|uuid|exists:users,id',<br>            'record_references' =&gt; 'sometimes|array',<br>        ]);</p><p>        $record = ArchivedClinicRecord::create([<br>            'former_doctor_id' =&gt; $validated['former_doctor_id'],<br>            'clinic_id' =&gt; $request-&gt;user()-&gt;clinic_id,<br>            'archived_patient_id' =&gt; $validated['archived_patient_id'],<br>            'record_references' =&gt; $validated['record_references'] ?? [],<br>            'archived_at' =&gt; now()-&gt;toDateString(),<br>        ]);</p><p>        return response()-&gt;json(['record' =&gt; $record], 201);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.12 DigitalAnamnesisController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/DigitalAnamnesisController.php`  <br><strong>Route Prefix:</strong> `/api/anamnesis`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\DigitalAnamnesis;<br>use Illuminate\Http\Request;</p><p>class DigitalAnamnesisController extends Controller<br>{<br>    public function show(Request $request, string $patientId)<br>    {<br>        $anamnesis = DigitalAnamnesis::active()-&gt;where('patient_id', $patientId)-&gt;first();</p><p>        if (!$anamnesis) {<br>            return response()-&gt;json(['anamnesis' =&gt; null]);<br>        }</p><p>        return response()-&gt;json(['anamnesis' =&gt; $anamnesis]);<br>    }</p><p>    public function upsert(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'patient_id' =&gt; 'required|uuid|exists:users,id',<br>            'answers' =&gt; 'required|array',<br>        ]);</p><p>        $anamnesis = DigitalAnamnesis::updateOrCreate(<br>            ['patient_id' =&gt; $validated['patient_id']],<br>            [<br>                'answers' =&gt; $validated['answers'],<br>                'doctor_id' =&gt; $request-&gt;user()-&gt;isDoctor() ? $request-&gt;user()-&gt;id : null,<br>                'clinic_id' =&gt; $request-&gt;user()-&gt;clinic_id,<br>                'last_updated_by' =&gt; $request-&gt;user()-&gt;id,<br>            ]<br>        );</p><p>        return response()-&gt;json(['anamnesis' =&gt; $anamnesis]);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.13 PatientRecordController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/PatientRecordController.php`  <br><strong>Route Prefix:</strong> `/api/patient-records`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use App\Models\PatientRecord;<br>use Illuminate\Http\Request;</p><p>class PatientRecordController extends Controller<br>{<br>    public function index(Request $request)<br>    {<br>        $user = $request-&gt;user();<br>        $query = PatientRecord::active()-&gt;with(['patient:id,fullname,avatar', 'doctor:id,fullname,avatar']);</p><p>        if ($user-&gt;isDoctor()) {<br>            $query-&gt;where('doctor_id', $user-&gt;id);<br>        } elseif ($user-&gt;isPatient()) {<br>            $query-&gt;where('patient_id', $user-&gt;id);<br>        } elseif ($user-&gt;isClinicOwner()) {<br>            $query-&gt;where('clinic_id', $user-&gt;clinic_id);<br>        }</p><p>        $query-&gt;when($request-&gt;patient_id, fn($q, $v) =&gt; $q-&gt;where('patient_id', $v))<br>              -&gt;when($request-&gt;record_type, fn($q, $v) =&gt; $q-&gt;where('record_type', $v));</p><p>        return response()-&gt;json($query-&gt;orderByDesc('created_at')-&gt;paginate($request-&gt;per_page ?? 20));<br>    }</p><p>    public function store(Request $request)<br>    {<br>        $validated = $request-&gt;validate([<br>            'patient_id' =&gt; 'required|uuid|exists:users,id',<br>            'clinic_id' =&gt; 'sometimes|uuid|exists:clinics,id',<br>            'file_url' =&gt; 'required|string|url',<br>            'record_type' =&gt; 'required|in:labResult,report,scan,other',<br>            'description' =&gt; 'sometimes|string|max:500',<br>        ]);</p><p>        $validated['doctor_id'] = $request-&gt;user()-&gt;id;<br>        $validated['upload_date'] = now()-&gt;toDateString();</p><p>        $record = PatientRecord::create($validated);</p><p>        return response()-&gt;json(['record' =&gt; $record], 201);<br>    }</p><p>    public function show(string $id)<br>    {<br>        return response()-&gt;json(['record' =&gt; PatientRecord::active()-&gt;with(['patient:id,fullname', 'doctor:id,fullname'])-&gt;findOrFail($id)]);<br>    }</p><p>    public function destroy(string $id)<br>    {<br>        PatientRecord::active()-&gt;findOrFail($id)-&gt;update(['is_active' =&gt; false]);<br>        return response()-&gt;json(['message' =&gt; 'Record deleted.']);<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p><h2 style="border-bottom:2px solid #0d9488;padding-bottom:4px;margin-top:30px">2.14 MediaStreamController</h2></p><p><strong>Dosya:</strong> `app/Http/Controllers/Api/MediaStreamController.php`  <br><strong>Route:</strong> `GET /api/media/stream/{path}`</p><p><pre style="background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;line-height:1.5"><code>&lt;?php</p><p>namespace App\Http\Controllers\Api;</p><p>use App\Http\Controllers\Controller;<br>use Illuminate\Http\Request;<br>use Illuminate\Support\Facades\Storage;<br>use Symfony\Component\HttpFoundation\StreamedResponse;</p><p>class MediaStreamController extends Controller<br>{<br>    /**<br>     * Stream a media file with Range request support (HTTP 206 Partial Content).<br>     * This enables video seeking in browsers even when the web server<br>     * (e.g. php artisan serve) does not natively support Range requests.<br>     *<br>     * GET /api/media/stream/{path}<br>     */<br>    public function stream(Request $request, string $path)<br>    {<br>        $disk = Storage::disk('public');</p><p>        if (!$disk-&gt;exists($path)) {<br>            abort(404, 'File not found');<br>        }</p><p>        $fullPath = $disk-&gt;path($path);<br>        $fileSize = filesize($fullPath);<br>        $mimeType = mime_content_type($fullPath) ?: 'application/octet-stream';</p><p>        $start = 0;<br>        $end = $fileSize - 1;<br>        $statusCode = 200;<br>        $headers = [<br>            'Content-Type'   =&gt; $mimeType,<br>            'Accept-Ranges'  =&gt; 'bytes',<br>            'Cache-Control'  =&gt; 'public, max-age=86400',<br>            'Content-Disposition' =&gt; 'inline',<br>        ];</p><p>        $rangeHeader = $request-&gt;header('Range');<br>        if ($rangeHeader) {<br>            $statusCode = 206;</p><p>            if (preg_match('/bytes=(\d+)-(\d*)/', $rangeHeader, $matches)) {<br>                $start = intval($matches[1]);<br>                if (!empty($matches[2])) {<br>                    $end = intval($matches[2]);<br>                }<br>            }</p><p>            if ($start &gt; $end || $start &gt;= $fileSize) {<br>                return response('', 416, [<br>                    'Content-Range' =&gt; "bytes */{$fileSize}",<br>                ]);<br>            }</p><p>            $end = min($end, $fileSize - 1);<br>            $length = $end - $start + 1;</p><p>            $headers['Content-Range'] = "bytes {$start}-{$end}/{$fileSize}";<br>            $headers['Content-Length'] = $length;<br>        } else {<br>            $headers['Content-Length'] = $fileSize;<br>        }</p><p>        $response = new StreamedResponse(function () use ($fullPath, $start, $end) {<br>            $handle = fopen($fullPath, 'rb');<br>            if ($handle === false) {<br>                return;<br>            }</p><p>            fseek($handle, $start);<br>            $remaining = $end - $start + 1;<br>            $bufferSize = 8192;</p><p>            while ($remaining &gt; 0 &amp;&amp; !feof($handle)) {<br>                $read = min($bufferSize, $remaining);<br>                $data = fread($handle, $read);<br>                if ($data === false) {<br>                    break;<br>                }<br>                echo $data;<br>                $remaining -= strlen($data);<br>                flush();<br>            }</p><p>            fclose($handle);<br>        }, $statusCode, $headers);</p><p>        return $response;<br>    }<br>}<br></code></pre></p><p><hr style="margin:30px 0"></p><p>*Bu doküman MedaGama backend kaynak kodunun referans kopyasıdır — Bölüm 2.*  <br>*Oluşturulma tarihi: 19 Şubat 2026*<br></p>
</body></html>