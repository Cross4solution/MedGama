# ╔══════════════════════════════════════════════════════════════════╗
# ║  MedGama — CI/CD Pipeline                                     ║
# ║  Runs on every push & PR to main / new-development             ║
# ║  Jobs: Backend tests (PHPUnit) + Frontend build (React)        ║
# ╚══════════════════════════════════════════════════════════════════╝

name: CI

on:
  push:
    branches: [main, new-development]
  pull_request:
    branches: [main, new-development]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ══════════════════════════════════════════════
  #  Backend — Laravel Tests
  # ══════════════════════════════════════════════
  backend:
    name: Backend Tests (PHP 8.3 + PostgreSQL)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: medgama_test
          POSTGRES_USER: medgama
          POSTGRES_PASSWORD: secret
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo_pgsql, pgsql, redis, gd, zip, intl, mbstring, bcmath, pcntl
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: composer-${{ hashFiles('backend/composer.lock') }}
          restore-keys: composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Prepare environment
        run: |
          cp .env.example .env
          sed -i 's/APP_ENV=production/APP_ENV=testing/' .env
          sed -i 's/APP_DEBUG=false/APP_DEBUG=true/' .env
          sed -i 's/DB_HOST=postgres/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_DATABASE=medgama/DB_DATABASE=medgama_test/' .env
          sed -i 's/DB_USERNAME=medgama/DB_USERNAME=medgama/' .env
          sed -i 's/DB_PASSWORD=/DB_PASSWORD=secret/' .env
          sed -i 's/REDIS_HOST=redis/REDIS_HOST=127.0.0.1/' .env
          sed -i 's/CACHE_STORE=redis/CACHE_STORE=array/' .env
          sed -i 's/QUEUE_CONNECTION=redis/QUEUE_CONNECTION=sync/' .env
          sed -i 's/SESSION_DRIVER=redis/SESSION_DRIVER=array/' .env
          sed -i 's/BROADCAST_CONNECTION=reverb/BROADCAST_CONNECTION=log/' .env
          php artisan key:generate

      - name: Run migrations
        run: php artisan migrate --force

      - name: Run tests
        run: php artisan test --no-coverage

  # ══════════════════════════════════════════════
  #  Frontend — React Build
  # ══════════════════════════════════════════════
  frontend:
    name: Frontend Build (Node 20)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build
        run: npx react-scripts build
        env:
          CI: false
          REACT_APP_API_BASE: https://api.medgama.com/api
          REACT_APP_ENABLE_MOCK: false

  # ══════════════════════════════════════════════
  #  Docker Build Verification (optional)
  # ══════════════════════════════════════════════
  docker:
    name: Docker Build Check
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build backend Docker image
        run: docker build -t medgama-app:test ./backend

      - name: Verify image
        run: docker run --rm medgama-app:test php -v
