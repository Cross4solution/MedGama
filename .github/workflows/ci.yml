# ╔══════════════════════════════════════════════════════════════════╗
# ║  MedaGama — CI/CD Pipeline                                     ║
# ║  Runs on every push & PR to main / new-development             ║
# ║  Jobs: Backend tests (PHPUnit) + Frontend build (React)        ║
# ╚══════════════════════════════════════════════════════════════════╝

name: CI

on:
  push:
    branches: [main, new-development]
  pull_request:
    branches: [main, new-development]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ══════════════════════════════════════════════
  #  Backend — Laravel Tests
  # ══════════════════════════════════════════════
  backend:
    name: Backend Tests (PHP 8.3 + PostgreSQL)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: medagama_test
          POSTGRES_USER: medagama
          POSTGRES_PASSWORD: secret
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo_pgsql, pgsql, redis, gd, zip, intl, mbstring, bcmath, pcntl
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: composer-${{ hashFiles('backend/composer.lock') }}
          restore-keys: composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Prepare environment
        run: |
          cat > .env <<'EOF'
          APP_NAME=MedaGama
          APP_ENV=testing
          APP_KEY=
          APP_DEBUG=true
          APP_URL=http://127.0.0.1:8001
          FRONTEND_URL=http://localhost:3000
          DB_CONNECTION=pgsql
          DB_HOST=127.0.0.1
          DB_PORT=5432
          DB_DATABASE=medagama_test
          DB_USERNAME=medagama
          DB_PASSWORD=secret
          CACHE_STORE=array
          QUEUE_CONNECTION=sync
          SESSION_DRIVER=array
          MAIL_MAILER=array
          BROADCAST_CONNECTION=log
          BCRYPT_ROUNDS=4
          EOF
          sed -i 's/^          //' .env
          php artisan key:generate

      - name: Run migrations
        run: php artisan migrate:fresh --force

      - name: Run tests
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: medagama_test
          DB_USERNAME: medagama
          DB_PASSWORD: secret
        run: php artisan test --no-coverage

  # ══════════════════════════════════════════════
  #  Frontend — React Build
  # ══════════════════════════════════════════════
  frontend:
    name: Frontend Build (Node 20)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build
        run: npx react-scripts build
        env:
          CI: false
          REACT_APP_API_BASE: https://api.medagama.com/api
          REACT_APP_ENABLE_MOCK: false

  # ══════════════════════════════════════════════
  #  Docker Build Verification (optional)
  # ══════════════════════════════════════════════
  docker:
    name: Docker Build Check
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build backend Docker image
        run: docker build -t medagama-app:test ./backend

      - name: Verify image
        run: docker run --rm medagama-app:test php -v
